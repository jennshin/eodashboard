/*!
Rotate vector features interaction for OpenLayers

@package ol-rotate-feature
@author Vladimir Vershinin <ghettovoice@gmail.com>
@version 3.0.1
@licence MIT
@copyright (c) 2016-2020, Vladimir Vershinin <ghettovoice@gmail.com>
*/
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("ol/interaction"),require("ol"),require("ol/layer"),require("ol/source"),require("ol/geom"),require("ol/style"),require("ol/extent"),require("ol/events/condition")):"function"==typeof define&&define.amd?define("ol-rotate-feature",["ol/interaction","ol","ol/layer","ol/source","ol/geom","ol/style","ol/extent","ol/events/condition"],t):(e=e||self).RotateFeatureInteraction=t(e.ol.interaction,e.ol,e.ol.layer,e.ol.source,e.ol.geom,e.ol.style,e.ol.extent,e.ol.events.condition)}(this,(function(e,t,r,n,o,i,a,s){"use strict";var u=function(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e};function c(e,t,r){return e(r={path:t,exports:{},require:function(e,t){return function(){throw new Error("Dynamic requires are not currently supported by @rollup/plugin-commonjs")}(null==t&&r.path)}},r.exports),r.exports}var l=c((function(e){function t(r){return"function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?e.exports=t=function(e){return typeof e}:e.exports=t=function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},t(r)}e.exports=t}));var h=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")};function f(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}var g=function(e,t,r){return t&&f(e.prototype,t),r&&f(e,r),e},p=c((function(e){function t(r){return e.exports=t=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},t(r)}e.exports=t}));var _=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=p(e)););return e},d=c((function(e){function t(r,n,o){return"undefined"!=typeof Reflect&&Reflect.get?e.exports=t=Reflect.get:e.exports=t=function(e,t,r){var n=_(e,t);if(n){var o=Object.getOwnPropertyDescriptor(n,t);return o.get?o.get.call(r):o.value}},t(r,n,o||r)}e.exports=t})),y=c((function(e){function t(r,n){return e.exports=t=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},t(r,n)}e.exports=t}));var v=function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&y(e,t)};var w=function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e};var A=function(e,t){return!t||"object"!==l(t)&&"function"!=typeof t?w(e):t};function F(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";if(t=["Assertion failed",t].join(": "),!e)throw new Error(t)}function m(e){return e}function b(e,t){return-1!==e.indexOf(t)}function k(e){return"[object Array]"===Object.prototype.toString.call(e)}var C="rotatestart",x="rotating",O="rotateend",E=function(){function e(t,r,n,o){h(this,e),this.propagationStopped_=!1,this.type_=t,this.features_=r,this.angle_=n,this.anchor_=o}return g(e,[{key:"preventDefault",value:function(){this.propagationStopped_=!0}},{key:"stopPropagation",value:function(){this.propagationStopped_=!0}},{key:"propagationStopped",get:function(){return this.propagationStopped_}},{key:"type",get:function(){return this.type_}},{key:"features",get:function(){return this.features_}},{key:"angle",get:function(){return this.angle_}},{key:"anchor",get:function(){return this.anchor_}}]),e}(),S="undefined"!=typeof navigator?navigator.userAgent.toLowerCase():"",M=-1!==S.indexOf("macintosh"),R=-1!==S.indexOf("webkit")&&-1==S.indexOf("edge");function P(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=p(e);if(t){var o=p(this).constructor;r=Reflect.construct(n,arguments,o)}else r=n.apply(this,arguments);return A(this,r)}}var j=function(e){v(a,e);var i=P(a);function a(){var e,o,u=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if(h(this,a),(o=i.call(this,{handleDownEvent:G,handleUpEvent:q,handleDragEvent:U,handleMoveEvent:D})).previousCursor_=void 0,o.anchorFeature_=void 0,o.arrowFeature_=void 0,o.lastCoordinate_=void 0,o.anchorMoving_=!1,o.overlay_=new r.Vector({style:u.style||I(),source:new n.Vector({features:new t.Collection})}),o.condition_=u.condition?u.condition:s.always,o.features_=void 0,u.features)if(k(u.features))o.features_=new t.Collection(u.features);else{if(!(u.features instanceof t.Collection))throw new Error("Features option should be an array or collection of features, got "+l(u.features));o.features_=u.features}else o.features_=new t.Collection;return o.allowAnchorMovement=void 0===u.allowAnchorMovement||u.allowAnchorMovement,o.setAnchor(u.anchor||T(o.features_)),o.setAngle(u.angle||0),o.features_.on("add",(e=o).onFeatureAdd_.bind(e)),o.features_.on("remove",(e=o).onFeatureRemove_.bind(e)),o.on("change:angle",(e=o).onAngleChange_.bind(e)),o.on("change:anchor",(e=o).onAnchorChange_.bind(e)),o.createOrUpdateAnchorFeature_(),o.createOrUpdateArrowFeature_(),o}return g(a,[{key:"setMap",value:function(e){this.overlay_.setMap(e),d(p(a.prototype),"setMap",this).call(this,e)}},{key:"setActive",value:function(e){this.overlay_&&this.overlay_.setMap(e?this.map:void 0),d(p(a.prototype),"setActive",this).call(this,e)}},{key:"setAngle",value:function(e){F(!isNaN(parseFloat(e)),"Numeric value passed"),this.set("angle",parseFloat(e))}},{key:"getAngle",value:function(){return this.get("angle")}},{key:"setAnchor",value:function(e){F(null==e||k(e)&&2===e.length,"Array of two elements passed"),this.set("anchor",null!=e?e.map(parseFloat):T(this.features_))}},{key:"getAnchor",value:function(){return this.get("anchor")}},{key:"createOrUpdateAnchorFeature_",value:function(){var e,r=this.getAngle(),n=this.getAnchor();n&&(this.anchorFeature_?(this.anchorFeature_.getGeometry().setCoordinates(n),this.anchorFeature_.set("angle",r)):(this.anchorFeature_=new t.Feature((e={geometry:new o.Point(n)},u(e,"angle",r),u(e,"rotate-anchor",!0),e)),this.overlay_.getSource().addFeature(this.anchorFeature_)))}},{key:"createOrUpdateArrowFeature_",value:function(){var e,r=this.getAngle(),n=this.getAnchor();n&&(this.arrowFeature_?(this.arrowFeature_.getGeometry().setCoordinates(n),this.arrowFeature_.set("angle",r)):(this.arrowFeature_=new t.Feature((e={geometry:new o.Point(n)},u(e,"angle",r),u(e,"rotate-arrow",!0),e)),this.overlay_.getSource().addFeature(this.arrowFeature_)))}},{key:"resetAngleAndAnchor_",value:function(){this.resetAngle_(),this.resetAnchor_()}},{key:"resetAngle_",value:function(){this.set("angle",0,!0),this.arrowFeature_&&this.arrowFeature_.set("angle",this.getAngle()),this.anchorFeature_&&this.anchorFeature_.set("angle",this.getAngle())}},{key:"resetAnchor_",value:function(){this.set("anchor",T(this.features_),!0),this.getAnchor()&&(this.arrowFeature_&&this.arrowFeature_.getGeometry().setCoordinates(this.getAnchor()),this.anchorFeature_&&this.anchorFeature_.getGeometry().setCoordinates(this.getAnchor()))}},{key:"onFeatureAdd_",value:function(){this.resetAngleAndAnchor_(),this.createOrUpdateAnchorFeature_(),this.createOrUpdateArrowFeature_()}},{key:"onFeatureRemove_",value:function(){this.resetAngleAndAnchor_(),this.features_.getLength()?(this.createOrUpdateAnchorFeature_(),this.createOrUpdateArrowFeature_()):(this.overlay_.getSource().clear(),this.anchorFeature_=this.arrowFeature_=void 0)}},{key:"onAngleChange_",value:function(e){var t=this,r=e.oldValue;this.features_.forEach((function(e){return e.getGeometry().rotate(t.getAngle()-r,t.getAnchor())})),this.arrowFeature_&&this.arrowFeature_.set("angle",this.getAngle()),this.anchorFeature_&&this.anchorFeature_.set("angle",this.getAngle())}},{key:"onAnchorChange_",value:function(){var e=this.getAnchor();e&&(this.anchorFeature_&&this.anchorFeature_.getGeometry().setCoordinates(e),this.arrowFeature_&&this.arrowFeature_.getGeometry().setCoordinates(e))}},{key:"dispatchRotateStartEvent_",value:function(e){this.dispatchEvent(new E(C,e,this.getAngle(),this.getAnchor()))}},{key:"dispatchRotatingEvent_",value:function(e){this.dispatchEvent(new E(x,e,this.getAngle(),this.getAnchor()))}},{key:"dispatchRotateEndEvent_",value:function(e){this.dispatchEvent(new E(O,e,this.getAngle(),this.getAnchor()))}},{key:"features",get:function(){return this.features_}},{key:"angle",get:function(){return this.getAngle()},set:function(e){this.setAngle(e)}},{key:"anchor",get:function(){return this.getAnchor()},set:function(e){this.setAnchor(e)}},{key:"map",set:function(e){this.setMap(e)},get:function(){return this.getMap()}},{key:"active",set:function(e){this.setActive(e)},get:function(){return this.getActive()}}]),a}(e.Pointer);function G(e){if(!s.mouseOnly(e))return!1;if(0==(r=e.originalEvent).button&&!(R&&M&&r.ctrlKey)&&this.condition_(e)){var t=e.map.forEachFeatureAtPixel(e.pixel,m);if(b(["click","singleclick","dblclick"],e.type)&&b([this.anchorFeature_,this.arrowFeature_],t))return!1;if(t&&!this.lastCoordinate_&&(b(this.features_.getArray(),t)||t===this.arrowFeature_))return this.lastCoordinate_=e.coordinate,D.call(this,e),this.dispatchRotateStartEvent_(this.features_),!0;if(t&&t===this.anchorFeature_&&this.allowAnchorMovement)return this.anchorMoving_=!0,D.call(this,e),!0}var r;return!1}function q(e){return this.lastCoordinate_?(this.lastCoordinate_=void 0,D.call(this,e),this.dispatchRotateEndEvent_(this.features_),!0):!!this.anchorMoving_&&(this.anchorMoving_=!1,D.call(this,e),!0)}function U(e){var t=e.coordinate,r=this.anchorFeature_.getGeometry().getCoordinates();if(this.lastCoordinate_){var n=[this.lastCoordinate_[0]-r[0],this.lastCoordinate_[1]-r[1]],o=[t[0]-r[0],t[1]-r[1]],i=Math.atan2(n[0]*o[1]-o[0]*n[1],n[0]*o[0]+n[1]*o[1]);this.setAngle(this.getAngle()+i),this.dispatchRotatingEvent_(this.features_),this.lastCoordinate_=t}else this.anchorMoving_&&this.setAnchor(t)}function D(e){var t=e.map,r=e.pixel,n=t.getTargetElement(),o=t.forEachFeatureAtPixel(r,m),i=function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];t&&(n.style.cursor="-webkit-"+e,n.style.cursor="-moz-"+e),n.style.cursor=e};this.lastCoordinate_?(this.previousCursor_=n.style.cursor,i("grabbing",!0)):o&&(b(this.features_.getArray(),o)||o===this.arrowFeature_)?(this.previousCursor_=n.style.cursor,i("grab",!0)):o&&o===this.anchorFeature_&&this.allowAnchorMovement||this.anchorMoving_?(this.previousCursor_=n.style.cursor,i("crosshair")):(i(this.previousCursor_||""),this.previousCursor_=void 0)}function I(){var e,t=[255,255,255,.8],r=[0,153,255,.8],n=[255,255,255,.01],a=(u(e={},"rotate-anchor",[new i.Style({image:new i.RegularShape({fill:new i.Fill({color:[0,153,255,.8]}),stroke:new i.Stroke({color:r,width:1}),radius:4,points:6}),zIndex:1/0})]),u(e,"rotate-arrow",[new i.Style({fill:new i.Fill({color:n}),stroke:new i.Stroke({color:t,width:4}),text:new i.Text({font:"12px sans-serif",offsetX:20,offsetY:-20,fill:new i.Fill({color:"blue"}),stroke:new i.Stroke({color:t,width:3})}),zIndex:1/0}),new i.Style({fill:new i.Fill({color:n}),stroke:new i.Stroke({color:r,width:2}),zIndex:1/0})]),e);return function(e,t){var r,n=e.get("angle")||0;switch(!0){case e.get("rotate-anchor"):return(r=a["rotate-anchor"])[0].getImage().setRotation(-n),r;case e.get("rotate-arrow"):r=a["rotate-arrow"];var i=e.getGeometry().getCoordinates(),s=new o.Polygon([[[i[0],i[1]-6*t],[i[0]+8*t,i[1]-12*t],[i[0],i[1]+30*t],[i[0]-8*t,i[1]-12*t],[i[0],i[1]-6*t]]]);return s.rotate(n,i),r[0].setGeometry(s),r[1].setGeometry(s),r[0].getText().setText(Math.round(180*-n/Math.PI)+"Â°"),r}}}function T(e){if((e=e instanceof t.Collection?e.getArray():e).length)return a.getCenter(function(e){if((e=e instanceof t.Collection?e.getArray():e).length)return new o.GeometryCollection(e.map((function(e){return e.getGeometry()}))).getExtent()}(e))}return"undefined"!=typeof window&&window.ol&&window.ol.interaction&&(window.ol.interaction.RotateFeature=j),j}));
//# sourceMappingURL=ol-rotate-feature.umd.min.js.map
