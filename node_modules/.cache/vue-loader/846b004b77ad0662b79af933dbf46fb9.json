{"remainingRequest":"/Users/8ps/Downloads/eodash-staging/app/node_modules/vue-loader/lib/index.js??vue-loader-options!/Users/8ps/Downloads/eodash-staging/app/src/components/IndicatorMap.vue?vue&type=script&lang=js&","dependencies":[{"path":"/Users/8ps/Downloads/eodash-staging/app/src/components/IndicatorMap.vue","mtime":1624532486000},{"path":"/Users/8ps/Downloads/eodash-staging/app/node_modules/cache-loader/dist/cjs.js","mtime":1624878747000},{"path":"/Users/8ps/Downloads/eodash-staging/app/node_modules/thread-loader/dist/cjs.js","mtime":1624878747000},{"path":"/Users/8ps/Downloads/eodash-staging/app/node_modules/babel-loader/lib/index.js","mtime":1624878747000},{"path":"/Users/8ps/Downloads/eodash-staging/app/node_modules/cache-loader/dist/cjs.js","mtime":1624878747000},{"path":"/Users/8ps/Downloads/eodash-staging/app/node_modules/vue-loader/lib/index.js","mtime":1624878753000}],"contextDependencies":[],"result":[{"type":"Buffer","data":"base64:Ly8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KCi8vIFV0aWxpdGllcwppbXBvcnQgewogIG1hcFN0YXRlLAogIG1hcEdldHRlcnMsCn0gZnJvbSAndnVleCc7CmltcG9ydCB7CiAgZ2VvSnNvbiwgbGF0TG5nQm91bmRzLCBsYXRMbmcsIGNpcmNsZU1hcmtlciwgRGl2SWNvbiwgUG9pbnQsCn0gZnJvbSAnbGVhZmxldCc7CmltcG9ydCB7IHRlbXBsYXRlIH0gZnJvbSAnQC91dGlscyc7CmltcG9ydCB7CiAgTE1hcCwgTFRpbGVMYXllciwgTFdNU1RpbGVMYXllciwgTEdlb0pzb24sIExDaXJjbGVNYXJrZXIsCiAgTENvbnRyb2xMYXllcnMsIExDb250cm9sQXR0cmlidXRpb24sIExDb250cm9sWm9vbSwgTExheWVyR3JvdXAsCiAgTEZlYXR1cmVHcm91cCwgTENvbnRyb2wsIExUb29sdGlwLAp9IGZyb20gJ3Z1ZTItbGVhZmxldCc7CmltcG9ydCB7IERhdGVUaW1lIH0gZnJvbSAnbHV4b24nOwoKaW1wb3J0ICdsZWFmbGV0L2Rpc3QvbGVhZmxldC5jc3MnOwppbXBvcnQgJ2xlYWZsZXQtbW91c2UtcG9zaXRpb24nOwppbXBvcnQgJ2xlYWZsZXQtc2lkZS1ieS1zaWRlJzsKaW1wb3J0ICdsZWFmbGV0LWxvYWRpbmcnOwppbXBvcnQgJ2xlYWZsZXQtbG9hZGluZy9zcmMvQ29udHJvbC5Mb2FkaW5nLmNzcyc7CmltcG9ydCAnbGVhZmxldC1kcmF3JzsKaW1wb3J0ICdsZWFmbGV0LWRyYXcvZGlzdC9sZWFmbGV0LmRyYXcuY3NzJzsKCmltcG9ydCBWdWUyTGVhZmxldE1hcmtlckNsdXN0ZXIgZnJvbSAndnVlMi1sZWFmbGV0LW1hcmtlcmNsdXN0ZXInOwppbXBvcnQgJ2xlYWZsZXQubWFya2VyY2x1c3Rlci9kaXN0L01hcmtlckNsdXN0ZXIuY3NzJzsgLy8gZXNsaW50LWRpc2FibGUtbGluZSBpbXBvcnQvbm8tZXh0cmFuZW91cy1kZXBlbmRlbmNpZXMKaW1wb3J0ICdsZWFmbGV0Lm1hcmtlcmNsdXN0ZXIvZGlzdC9NYXJrZXJDbHVzdGVyLkRlZmF1bHQuY3NzJzsgLy8gZXNsaW50LWRpc2FibGUtbGluZSBpbXBvcnQvbm8tZXh0cmFuZW91cy1kZXBlbmRlbmNpZXMKaW1wb3J0IHR1cmZEaWZmZXJlbmNlIGZyb20gJ0B0dXJmL2RpZmZlcmVuY2UnOwoKaW1wb3J0IGNvdW50cmllcyBmcm9tICdAL2Fzc2V0cy9jb3VudHJpZXMuanNvbic7CmltcG9ydCBnc2FGaWxlIGZyb20gJ0AvYXNzZXRzL2dzYV9kYXRhLmpzb24nOwoKCmNvbnN0IGVtcHR5RiA9IHsKICB0eXBlOiAnRmVhdHVyZUNvbGxlY3Rpb24nLAogIGZlYXR1cmVzOiBbXSwKfTsKbGV0IGRhdGFGID0gZW1wdHlGOwpsZXQgY29tcGFyZUYgPSBlbXB0eUY7CgpleHBvcnQgZGVmYXVsdCB7CiAgcHJvcHM6IFsKICAgICdjdXJyZW50SW5kaWNhdG9yJywKICBdLAogIGNvbXBvbmVudHM6IHsKICAgIExNYXAsCiAgICBMVGlsZUxheWVyLAogICAgTFdNU1RpbGVMYXllciwKICAgIExHZW9Kc29uLAogICAgTENpcmNsZU1hcmtlciwKICAgIExDb250cm9sTGF5ZXJzLAogICAgTENvbnRyb2xBdHRyaWJ1dGlvbiwKICAgIExDb250cm9sWm9vbSwKICAgIExMYXllckdyb3VwLAogICAgTEZlYXR1cmVHcm91cCwKICAgIExDb250cm9sLAogICAgTFRvb2x0aXAsCiAgICAnbC1tYXJrZXItY2x1c3Rlcic6IFZ1ZTJMZWFmbGV0TWFya2VyQ2x1c3RlciwKICB9LAogIGRhdGEoKSB7CiAgICByZXR1cm4gewogICAgICBtYXA6IG51bGwsCiAgICAgIGNvbXBhcmVMYXllcktleVhZWjogWzEsIDIsIDMsIDQsIDUsIDYsIDcsIDgsIDksIDEwLCAxMSwgMTIsIDEzLCAxNCwgMTVdLAogICAgICBkYXRhTGF5ZXJLZXlYWVo6IFs0MSwgNDIsIDQzLCA0NCwgNDUsIDQ2LCA0NywgNDgsIDQ5LCA1MCwgNTEsIDUyLCA1MywgNTQsIDU1XSwKICAgICAgZGF0YUpzb25LZXk6IDAsCiAgICAgIGNvbXBhcmVKc29uS2V5OiAtMSwKICAgICAgem9vbTogbnVsbCwKICAgICAgY2VudGVyOiBudWxsLAogICAgICBib3VuZHM6IG51bGwsCiAgICAgIGVuYWJsZUNvbXBhcmU6IGZhbHNlLAogICAgICBvcGFjaXR5VGVycmFpbjogWzFdLAogICAgICBvcGFjaXR5T3ZlcmxheTogWzFdLAogICAgICB0aWxlUGFuZTogJ3RpbGVQYW5lJywKICAgICAgb3ZlcmxheVBhbmU6ICdvdmVybGF5UGFuZScsCiAgICAgIG1hcmtlclBhbmU6ICdtYXJrZXJQYW5lJywKICAgICAgc2hhZG93UGFuZTogJ3NoYWRvd1BhbmUnLAogICAgICB0b29sdGlwUGFuZTogJ3Rvb2x0aXBQYW5lJywKICAgICAgcG9wdXBQYW5lOiAncG9wdXBQYW5lJywKICAgICAgbGVnZW5kRXhwYW5kZWQ6IGZhbHNlLAogICAgICBzbGlkZXI6IG51bGwsCiAgICAgIGRyYXdDb250cm9sOiBudWxsLAogICAgICByZW5kZXJUcmFzaEJpbjogZmFsc2UsCiAgICAgIGRlZmF1bHRNYXBPcHRpb25zOiB7CiAgICAgICAgYXR0cmlidXRpb25Db250cm9sOiBmYWxzZSwKICAgICAgICB6b29tQ29udHJvbDogZmFsc2UsCiAgICAgIH0sCiAgICAgIGRhdGFMYXllclRpbWU6IG51bGwsCiAgICAgIGNvbXBhcmVMYXllclRpbWU6IG51bGwsCiAgICAgIGRhdGFMYXllckluZGV4OiAwLAogICAgICBjb21wYXJlTGF5ZXJJbmRleDogMCwKICAgICAgZGF0YUZlYXR1cmVzQ291bnQ6IDAsCiAgICAgIGNvbXBhcmVGZWF0dXJlc0NvdW50OiAwLAogICAgICBzZWxlY3RlZENvdW50cnk6IG51bGwsCiAgICAgIHNlbGVjdGVkQm9yZGVyOiBudWxsLAogICAgICBzZWxlY3RlZExheWVyOiBudWxsLAogICAgfTsKICB9LAogIGNvbXB1dGVkOiB7CiAgICAuLi5tYXBTdGF0ZSgnY29uZmlnJywgWydhcHBDb25maWcnLCAnYmFzZUNvbmZpZyddKSwKICAgIC4uLm1hcEdldHRlcnMoJ2luZGljYXRvcnMnLCBbCiAgICAgICdnZXRJbmRpY2F0b3JGaWx0ZXJlZElucHV0RGF0YScsCiAgICBdKSwKICAgIGNvdW50cmllc0pzb24oKSB7CiAgICAgIHJldHVybiBjb3VudHJpZXM7CiAgICB9LAogICAgZ3NhSnNvbigpIHsKICAgICAgcmV0dXJuIGdzYUZpbGU7CiAgICB9LAogICAgY291bnRyaWVzU3R5bGUoKSB7CiAgICAgIHJldHVybiB7CiAgICAgICAgY29sb3I6ICcjMjIyJywKICAgICAgICB3ZWlnaHQ6IDEsCiAgICAgICAgZmlsbENvbG9yOiAnI2ZmZicsCiAgICAgICAgb3BhY2l0eTogMSwKICAgICAgICBmaWxsT3BhY2l0eTogMC41LAogICAgICB9OwogICAgfSwKICAgIGRhdGFKc29uQ29tcHV0ZWQ6IHsKICAgICAgLy8gdG8gYXZvaWQgZWFjaCBvZiB0aG91c2FuZHMgb2YgZ2VvanNvbiBmZWF0dXJlcyBoYXZlIGl0cyBvd24KICAgICAgLy8gZ2V0dGVyL3NldHRlciBzZXQgYnkgdnVlIC0gZnJlZXppbmcgdGhlIGFwcCBvbiBsYXJnZSBudW1iZXIgb2YgcHRzCiAgICAgIC8vIHdlIG1hbnVhbGx5IHJlcmVuZGVyIHJlbGV2YW50IHZ1ZSBjb21wb25lbnRzIGFueXdheQogICAgICBnZXQ6ICgpID0+IHRoaXMuZ2V0RGF0YUYoKSwKICAgICAgc2V0OiAodikgPT4gewogICAgICAgIGRhdGFGID0gdjsKICAgICAgfSwKICAgIH0sCiAgICBjb21wYXJlSnNvbkNvbXB1dGVkOiB7CiAgICAgIGdldDogKCkgPT4gdGhpcy5nZXRDb21wYXJlRigpLAogICAgICBzZXQ6ICh2KSA9PiB7CiAgICAgICAgY29tcGFyZUYgPSB2OwogICAgICB9LAogICAgfSwKICAgIHN1YkFvaUludmVyc2VTdHlsZSgpIHsKICAgICAgcmV0dXJuIHsKICAgICAgICBzdHJva2U6IGZhbHNlLAogICAgICAgIGZpbGxDb2xvcjogdGhpcy5nZXRJbmRpY2F0b3JDb2xvcigncHJpbWFyeScpLAogICAgICAgIGZpbGxPcGFjaXR5OiB0aGlzLm1lcmdlZENvbmZpZ3MoKVswXS5zdWJBb2lGaWxsT3BhY2l0eSB8fCAwLjUsCiAgICAgIH07CiAgICB9LAogICAgYmFzZUxheWVycygpIHsKICAgICAgLy8gZXhwZWN0cyBhbiBhcnJheSBvZiBvYmplY3RzCiAgICAgIHJldHVybiB0aGlzLm1lcmdlZENvbmZpZ3MoKVswXS5iYXNlTGF5ZXJzIHx8IHRoaXMuYmFzZUNvbmZpZy5iYXNlTGF5ZXJzUmlnaHRNYXA7CiAgICB9LAogICAgb3ZlcmxheUxheWVycygpIHsKICAgICAgcmV0dXJuIHRoaXMubWVyZ2VkQ29uZmlncygpWzBdLm92ZXJsYXlMYXllcnMgfHwgdGhpcy5iYXNlQ29uZmlnLm92ZXJsYXlMYXllcnNSaWdodE1hcDsKICAgIH0sCiAgICBtYXBEZWZhdWx0cygpIHsKICAgICAgcmV0dXJuIHsKICAgICAgICAuLi50aGlzLmJhc2VDb25maWcubWFwRGVmYXVsdHMsCiAgICAgICAgLi4udGhpcy5tZXJnZWRDb25maWdzKClbMF0sCiAgICAgIH07CiAgICB9LAogICAgY291bnRyeVNlbGVjdGlvbigpIHsKICAgICAgcmV0dXJuIHRoaXMubWVyZ2VkQ29uZmlncygpWzBdLmNvdW50cnlTZWxlY3Rpb247CiAgICB9LAogICAgYm9yZGVyU2VsZWN0aW9uKCkgewogICAgICByZXR1cm4gdGhpcy5tZXJnZWRDb25maWdzKClbMF0uYm9yZGVyU2VsZWN0aW9uOwogICAgfSwKICAgIGluZERlZmluaXRpb24oKSB7CiAgICAgIHJldHVybiB0aGlzLmJhc2VDb25maWcuaW5kaWNhdG9yc0RlZmluaXRpb25bdGhpcy5pbmRpY2F0b3IuaW5kaWNhdG9yXTsKICAgIH0sCiAgICBhZGRpdGlvbmFsTWFwVGltZXMoKSB7CiAgICAgIHJldHVybiB0aGlzLmJhc2VDb25maWcuYWRkaXRpb25hbE1hcFRpbWVzICYmIHRoaXMuYmFzZUNvbmZpZy5hZGRpdGlvbmFsTWFwVGltZXNbYCR7dGhpcy5pbmRpY2F0b3IuYW9pSUR9LSR7dGhpcy5pbmRpY2F0b3IuaW5kaWNhdG9yfWBdOwogICAgfSwKICAgIGV4Y2x1ZGVNYXBUaW1lcygpIHsKICAgICAgcmV0dXJuIHRoaXMuYmFzZUNvbmZpZy5leGNsdWRlTWFwVGltZXMgJiYgdGhpcy5iYXNlQ29uZmlnLmV4Y2x1ZGVNYXBUaW1lc1tgJHt0aGlzLmluZGljYXRvci5hb2lJRH0tJHt0aGlzLmluZGljYXRvci5pbmRpY2F0b3J9YF07CiAgICB9LAogICAgcmVwbGFjZU1hcFRpbWVzKCkgewogICAgICByZXR1cm4gdGhpcy5iYXNlQ29uZmlnLnJlcGxhY2VNYXBUaW1lcyAmJiB0aGlzLmJhc2VDb25maWcucmVwbGFjZU1hcFRpbWVzW2Ake3RoaXMuaW5kaWNhdG9yLmFvaUlEfS0ke3RoaXMuaW5kaWNhdG9yLmluZGljYXRvcn1gXTsKICAgIH0sCiAgICBpbmRpY2F0b3IoKSB7CiAgICAgIHJldHVybiB0aGlzLmdldEluZGljYXRvckZpbHRlcmVkSW5wdXREYXRhKHRoaXMuY3VycmVudEluZGljYXRvciB8fCBudWxsKTsKICAgIH0sCiAgICBzaG93QW9pKCkgewogICAgICByZXR1cm4gdGhpcy5hb2kgJiYgKCF0aGlzLnN1YkFvaSB8fCB0aGlzLnN1YkFvaS5mZWF0dXJlcy5sZW5ndGggPT09IDApOwogICAgfSwKICAgIHZhbGlkRHJhd25BcmVhKCkgewogICAgICAvLyBhbGxvd3MgZm9yIGZ1cnRoZXIgdmFsaWRhdGlvbiBvbiBhcmVhIHNpemUgZXRjLgogICAgICByZXR1cm4gdGhpcy5kcmF3bkFyZWEgIT09IG51bGw7CiAgICB9LAogICAgZHJhd25BcmVhKCkgewogICAgICByZXR1cm4gdGhpcy4kc3RvcmUuc3RhdGUuZmVhdHVyZXMuc2VsZWN0ZWRBcmVhOwogICAgfSwKICAgIGN1c3RvbUFyZWFGaWx0ZXIoKSB7CiAgICAgIHJldHVybiB0aGlzLm1lcmdlZENvbmZpZ3MoKVswXS5jdXN0b21BcmVhRmVhdHVyZXMKICAgICAgICB8fCB0aGlzLm1lcmdlZENvbmZpZ3MoKVswXS5jdXN0b21BcmVhSW5kaWNhdG9yOwogICAgfSwKICAgIHVzZWRUaW1lcygpIHsKICAgICAgbGV0IHRpbWVzID0gdGhpcy5pbmRpY2F0b3IudGltZTsKICAgICAgbGV0IGVvU2Vuc29yID0gQXJyYXkuaXNBcnJheSh0aGlzLmluZGljYXRvci5lb1NlbnNvcikgJiYgdGhpcy5pbmRpY2F0b3IuZW9TZW5zb3I7CiAgICAgIGxldCBpbnB1dERhdGEgPSBBcnJheS5pc0FycmF5KHRoaXMuaW5kaWNhdG9yLmlucHV0RGF0YSkgJiYgdGhpcy5pbmRpY2F0b3IuaW5wdXREYXRhOwogICAgICBsZXQgY29sb3JDb2RlID0gQXJyYXkuaXNBcnJheSh0aGlzLmluZGljYXRvci5jb2xvckNvZGUpICYmIHRoaXMuaW5kaWNhdG9yLmNvbG9yQ29kZTsKICAgICAgLy8gY29tcGxldGVseSByZXBsYWNlIGdpdmVuIHRpbWVzIG9yIGVvU2Vuc29yCiAgICAgIGlmICh0aGlzLnJlcGxhY2VNYXBUaW1lcyAmJiBBcnJheS5pc0FycmF5KHRoaXMucmVwbGFjZU1hcFRpbWVzLnRpbWUpKSB7CiAgICAgICAgdGltZXMgPSB0aGlzLnJlcGxhY2VNYXBUaW1lcy50aW1lOwogICAgICB9CiAgICAgIGlmICh0aGlzLnJlcGxhY2VNYXBUaW1lcyAmJiBBcnJheS5pc0FycmF5KHRoaXMucmVwbGFjZU1hcFRpbWVzLmVvU2Vuc29yKSkgewogICAgICAgIGVvU2Vuc29yID0gdGhpcy5yZXBsYWNlTWFwVGltZXMuZW9TZW5zb3I7IC8vIGp1c3QgZm9yIGRpc3BsYXkKICAgICAgfQogICAgICBpZiAodGhpcy5yZXBsYWNlTWFwVGltZXMgJiYgQXJyYXkuaXNBcnJheSh0aGlzLnJlcGxhY2VNYXBUaW1lcy5pbnB1dERhdGEpKSB7CiAgICAgICAgaW5wdXREYXRhID0gdGhpcy5yZXBsYWNlTWFwVGltZXMuaW5wdXREYXRhOwogICAgICAgIC8vIG5lZWRzIHRvIGJlIHVzZWQgdW5sZXNzIGluZGljYXRvci5kaXNwbGF5IGlzIHVzZWQgKHRoYXQgb3ZlcnJpZGVzIGl0KQogICAgICB9CiAgICAgIGlmICh0aGlzLnJlcGxhY2VNYXBUaW1lcyAmJiBBcnJheS5pc0FycmF5KHRoaXMucmVwbGFjZU1hcFRpbWVzLmNvbG9yQ29kZSkpIHsKICAgICAgICBjb2xvckNvZGUgPSB0aGlzLnJlcGxhY2VNYXBUaW1lcy5jb2xvckNvZGU7CiAgICAgIH0KICAgICAgaWYgKHRoaXMuYWRkaXRpb25hbE1hcFRpbWVzKSB7CiAgICAgICAgLy8gYWRkIGFkZGl0aW9uYWwgdGltZXMgYW5kIGVvU2Vuc29yIHRvIG9yaWdpbmFsIGFycmF5cwogICAgICAgIC8vIHNvcnQgdGltZSBhc2NlbmRpbmcgYW5kIHNvcnQgYXJyYXlzIGJhc2VkIG9uIHRpbWUgYXJyYXkgdmlhIGhlbHBlciBsaXN0IGNvbWJpbmluZyBhbGwKICAgICAgICBjb25zdCBkdE9iamVjdHMgPSB0aGlzLmFkZGl0aW9uYWxNYXBUaW1lcy50aW1lLm1hcCgodCkgPT4gRGF0ZVRpbWUuZnJvbUlTTyh0KSk7CiAgICAgICAgY29uc3QgbWVyZ2VkVGltZXMgPSB0aW1lcy5jb25jYXQoZHRPYmplY3RzKTsKICAgICAgICBjb25zdCBtZXJnZWRTZW5zb3JzID0gZW9TZW5zb3IuY29uY2F0KHRoaXMuYWRkaXRpb25hbE1hcFRpbWVzLmVvU2Vuc29yKTsKICAgICAgICBjb25zdCBtZXJnZWRJbnB1dERhdGEgPSBpbnB1dERhdGEuY29uY2F0KHRoaXMuYWRkaXRpb25hbE1hcFRpbWVzLmlucHV0RGF0YSk7CiAgICAgICAgY29uc3QgbWVyZ2VkQ29sb3JDb2RlID0gY29sb3JDb2RlLmNvbmNhdCh0aGlzLmFkZGl0aW9uYWxNYXBUaW1lcy5jb2xvckNvZGUpOwogICAgICAgIC8vIGNvbWJpbmUgdGhlIGFycmF5cwogICAgICAgIGNvbnN0IGxpc3QgPSBbXTsKICAgICAgICBmb3IgKGxldCBqID0gMDsgaiA8IG1lcmdlZFRpbWVzLmxlbmd0aDsgaisrKSB7CiAgICAgICAgICBsaXN0LnB1c2goewogICAgICAgICAgICB0aW1lOiBtZXJnZWRUaW1lc1tqXSwKICAgICAgICAgICAgZW9TZW5zb3I6IG1lcmdlZFNlbnNvcnNbal0sCiAgICAgICAgICAgIGlucHV0RGF0YTogbWVyZ2VkSW5wdXREYXRhW2pdLAogICAgICAgICAgICBjb2xvckNvZGU6IG1lcmdlZENvbG9yQ29kZVtqXSwKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICAvLyBzb3J0IG1hcHBpbmcgYnkgdGltZSBhc2MKICAgICAgICBsaXN0LnNvcnQoKGEsIGIpID0+IChhLnRpbWUudG9NaWxsaXMoKSAtIGIudGltZS50b01pbGxpcygpKSk7CiAgICAgICAgLy8gc2VwYXJhdGUgdGhlbSBiYWNrIG91dAogICAgICAgIGZvciAobGV0IGsgPSAwOyBrIDwgbGlzdC5sZW5ndGg7IGsrKykgewogICAgICAgICAgbWVyZ2VkVGltZXNba10gPSBsaXN0W2tdLnRpbWU7CiAgICAgICAgICBtZXJnZWRTZW5zb3JzW2tdID0gbGlzdFtrXS5lb1NlbnNvcjsKICAgICAgICAgIG1lcmdlZElucHV0RGF0YVtrXSA9IGxpc3Rba10uaW5wdXREYXRhOwogICAgICAgICAgbWVyZ2VkQ29sb3JDb2RlW2tdID0gbGlzdFtrXS5jb2xvckNvZGU7CiAgICAgICAgfQogICAgICAgIHRpbWVzID0gbWVyZ2VkVGltZXM7CiAgICAgICAgZW9TZW5zb3IgPSBtZXJnZWRTZW5zb3JzOwogICAgICAgIGlucHV0RGF0YSA9IG1lcmdlZElucHV0RGF0YTsKICAgICAgICBjb2xvckNvZGUgPSBtZXJnZWRDb2xvckNvZGU7CiAgICAgIH0KICAgICAgaWYgKHRoaXMuZXhjbHVkZU1hcFRpbWVzICYmIEFycmF5LmlzQXJyYXkodGhpcy5leGNsdWRlTWFwVGltZXMpKSB7CiAgICAgICAgLy8gZXhjbHVkZSB0aW1lcyBhbmQgcmVzcGVjdGl2ZSBlbnRyaWVzIGZyb20gb3RoZXIgYXJyYXlzCiAgICAgICAgY29uc3QgZHRPYmplY3RzID0gdGhpcy5leGNsdWRlTWFwVGltZXMubWFwKCh0KSA9PiBEYXRlVGltZS5mcm9tSVNPKHQpKTsKICAgICAgICBjb25zdCBpbmRUb0RlbGV0ZSA9IHRpbWVzLnJlZHVjZSgoYSwgZSwgaSkgPT4gewogICAgICAgICAgLy8gZmluZCBpZiBhbnkgdGltZSBpcyBpbiB0byBiZSBkZWxldGVkCiAgICAgICAgICBjb25zdCBmb3VuZCA9IGR0T2JqZWN0cy5maW5kKCh0aW1lKSA9PiB0aW1lLnRvTWlsbGlzKCkgPT09IGUudG9NaWxsaXMoKSk7CiAgICAgICAgICBpZiAodHlwZW9mIGZvdW5kICE9PSAndW5kZWZpbmVkJykgewogICAgICAgICAgICAvLyBhZGQgaXRzIGluZGV4IHRvIGxpc3QKICAgICAgICAgICAgYS5wdXNoKGkpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGE7CiAgICAgICAgfSwgW10pOwogICAgICAgIC8vIHNldCBpdGVtcyBpbiBhbGwgYXJyYXlzIHRvIG51bGwKICAgICAgICBpbmRUb0RlbGV0ZS5mb3JFYWNoKChpKSA9PiB7CiAgICAgICAgICB0aW1lc1tpXSA9IG51bGw7CiAgICAgICAgICBpZiAodHlwZW9mIGVvU2Vuc29yW2ldICE9PSAndW5kZWZpbmVkJykgewogICAgICAgICAgICBlb1NlbnNvcltpXSA9IG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodHlwZW9mIGlucHV0RGF0YVtpXSAhPT0gJ3VuZGVmaW5lZCcpIHsKICAgICAgICAgICAgaW5wdXREYXRhW2ldID0gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0eXBlb2YgY29sb3JDb2RlW2ldICE9PSAndW5kZWZpbmVkJykgewogICAgICAgICAgICBjb2xvckNvZGVbaV0gPSBudWxsOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICAgIC8vIGZpbHRlciBvdXQgbnVsbHMKICAgICAgICB0aW1lcyA9IHRpbWVzLmZpbHRlcigoZSkgPT4gZSAhPT0gbnVsbCk7CiAgICAgICAgZW9TZW5zb3IgPSBlb1NlbnNvci5maWx0ZXIoKGUpID0+IGUgIT09IG51bGwpOwogICAgICAgIGlucHV0RGF0YSA9IGlucHV0RGF0YS5maWx0ZXIoKGUpID0+IGUgIT09IG51bGwpOwogICAgICAgIGNvbG9yQ29kZSA9IGNvbG9yQ29kZS5maWx0ZXIoKGUpID0+IGUgIT09IG51bGwpOwogICAgICB9CiAgICAgIHJldHVybiB7CiAgICAgICAgdGltZTogdGltZXMsIGVvU2Vuc29yLCBpbnB1dERhdGEsIGNvbG9yQ29kZSwKICAgICAgfTsKICAgIH0sCiAgICBhcnJheU9mT2JqZWN0cygpIHsKICAgICAgY29uc3Qgc2VsZWN0aW9uT3B0aW9ucyA9IFtdOwogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMudXNlZFRpbWVzLnRpbWUubGVuZ3RoOyBpICs9IDEpIHsKICAgICAgICBsZXQgbGFiZWwgPSB0aGlzLmdldFRpbWVMYWJlbCh0aGlzLnVzZWRUaW1lcy50aW1lW2ldKTsKICAgICAgICBpZiAodGhpcy51c2VkVGltZXMuZW9TZW5zb3IpIHsKICAgICAgICAgIGNvbnN0IGVvU2Vuc29yID0gdGhpcy51c2VkVGltZXMuZW9TZW5zb3IubGVuZ3RoID09PSAxCiAgICAgICAgICAgID8gdGhpcy51c2VkVGltZXMuZW9TZW5zb3JbMF0KICAgICAgICAgICAgOiB0aGlzLnVzZWRUaW1lcy5lb1NlbnNvcltpXTsKICAgICAgICAgIGxhYmVsICs9IGAgLSAke2VvU2Vuc29yfWA7CiAgICAgICAgfQogICAgICAgIHNlbGVjdGlvbk9wdGlvbnMucHVzaCh7CiAgICAgICAgICB2YWx1ZTogdGhpcy51c2VkVGltZXMudGltZVtpXSwKICAgICAgICAgIG5hbWU6IGxhYmVsLAogICAgICAgIH0pOwogICAgICB9CiAgICAgIHJldHVybiBzZWxlY3Rpb25PcHRpb25zOwogICAgfSwKICAgIGN1cnJlbnRUaW1lKCkgewogICAgICBsZXQgcmV0dXJuVGltZSA9IHRoaXMudXNlZFRpbWVzLnRpbWVbdGhpcy51c2VkVGltZXMudGltZS5sZW5ndGggLSAxXTsKICAgICAgaWYgKHRoaXMuZGF0YUxheWVyVGltZSAhPT0gbnVsbCkgewogICAgICAgIHJldHVyblRpbWUgPSB0aGlzLmRhdGFMYXllclRpbWU7CiAgICAgIH0KICAgICAgcmV0dXJuIHJldHVyblRpbWU7CiAgICB9LAogICAgY3VycmVudENvbXBhcmVUaW1lKCkgewogICAgICBsZXQgcmV0dXJuVGltZSA9IHRoaXMuZ2V0SW5pdGlhbENvbXBhcmVUaW1lKCk7CiAgICAgIGlmICh0aGlzLmNvbXBhcmVMYXllclRpbWUgIT09IG51bGwpIHsKICAgICAgICByZXR1cm5UaW1lID0gdGhpcy5jb21wYXJlTGF5ZXJUaW1lOwogICAgICB9CiAgICAgIGlmICh0aGlzLmluZGljYXRvci5jb21wYXJlRGlzcGxheSkgewogICAgICAgIC8vIHNoYXJlZCB0aW1lIG9uIGJvdGggbGF5ZXJzIGluIGNhc2Ugb2YgY29tcGFyZURpc3BsYXkgYmVpbmcgc2V0CiAgICAgICAgcmV0dXJuVGltZSA9IHRoaXMuZGF0YUxheWVyVGltZTsKICAgICAgfQogICAgICByZXR1cm4gcmV0dXJuVGltZTsKICAgIH0sCiAgICBhb2koKSB7CiAgICAgIHJldHVybiB0aGlzLmluZGljYXRvci5hb2k7CiAgICB9LAogICAgc3ViQW9pKCkgewogICAgICByZXR1cm4gdGhpcy5pbmRpY2F0b3Iuc3ViQW9pOwogICAgfSwKICAgIHN1YkFvaUludmVyc2UoKSB7CiAgICAgIC8vIGNyZWF0ZSBhbiBpbnZlcnNlIG9mIHN1YmFvaSwgdXNpbmcgZGlmZmVyZW5jZSBvZiB3aG9sZSB3b3JsZCBhbmQgc3ViYW9pCiAgICAgIGNvbnN0IHN1YmFvaUludiA9IEpTT04ucGFyc2UoSlNPTi5zdHJpbmdpZnkodGhpcy5zdWJBb2kpKTsKICAgICAgLy8gYm90aCBPYmplY3QuYXNzaWduKHt9LCB0aGlzLnN1YkFvaSkgYW5kIHsgLi4udGhpcy5zdWJBb2kgfSBjcmVhdGUgc2hhbGxvdyBjb3B5CiAgICAgIGlmIChzdWJhb2lJbnYuZmVhdHVyZXMubGVuZ3RoID09PSAxKSB7CiAgICAgICAgY29uc3QgZ2xvYmFsQm94ID0gewogICAgICAgICAgdHlwZTogJ0ZlYXR1cmUnLAogICAgICAgICAgcHJvcGVydGllczoge30sCiAgICAgICAgICBnZW9tZXRyeTogewogICAgICAgICAgICB0eXBlOiAnUG9seWdvbicsCiAgICAgICAgICAgIGNvb3JkaW5hdGVzOiBbW1stMTgwLCAtOTBdLCBbMTgwLCAtOTBdLCBbMTgwLCA5MF0sIFstMTgwLCA5MF0sIFstMTgwLCAtOTBdXV0sCiAgICAgICAgICB9LAogICAgICAgIH07CiAgICAgICAgY29uc3QgZGlmZiA9IHR1cmZEaWZmZXJlbmNlKGdsb2JhbEJveCwgc3ViYW9pSW52LmZlYXR1cmVzWzBdKTsKICAgICAgICBzdWJhb2lJbnYuZmVhdHVyZXNbMF0gPSBkaWZmOwogICAgICB9CiAgICAgIHJldHVybiBzdWJhb2lJbnY7CiAgICB9LAogICAgY2x1c3Rlck9wdGlvbnMoKSB7CiAgICAgIHJldHVybiB7CiAgICAgICAgZGlzYWJsZUNsdXN0ZXJpbmdBdFpvb206IDEzLAogICAgICAgIGFuaW1hdGU6IGZhbHNlLAogICAgICAgIC8vIHpvb21Ub0JvdW5kc09uQ2xpY2s6IGZhbHNlLAogICAgICAgIGljb25DcmVhdGVGdW5jdGlvbihjbHVzdGVyKSB7IC8vIGVzbGludC1kaXNhYmxlLWxpbmUgZnVuYy1uYW1lcwogICAgICAgICAgLy8gbW9kaWZpZWQgc2VsZWN0ZWQgY2x1c3RlciBzdHlsZQogICAgICAgICAgY29uc3QgY2hpbGRDb3VudCA9IGNsdXN0ZXIuZ2V0Q2hpbGRDb3VudCgpOwogICAgICAgICAgcmV0dXJuIG5ldyBEaXZJY29uKHsKICAgICAgICAgICAgaHRtbDogYDxkaXY+PHNwYW4+JHtjaGlsZENvdW50fTwvc3Bhbj48L2Rpdj5gLAogICAgICAgICAgICBjbGFzc05hbWU6ICdtYXJrZXItY2x1c3RlcicsCiAgICAgICAgICAgIGljb25TaXplOiBuZXcgUG9pbnQoNDAsIDQwKSwKICAgICAgICAgIH0pOwogICAgICAgIH0sCiAgICAgICAgcG9seWdvbk9wdGlvbnM6IHsKICAgICAgICAgIGZpbGxDb2xvcjogdGhpcy5hcHBDb25maWcuYnJhbmRpbmcucHJpbWFyeUNvbG9yLAogICAgICAgICAgY29sb3I6IHRoaXMuYXBwQ29uZmlnLmJyYW5kaW5nLnByaW1hcnlDb2xvciwKICAgICAgICAgIHdlaWdodDogMC41LAogICAgICAgICAgb3BhY2l0eTogMSwKICAgICAgICAgIGZpbGxPcGFjaXR5OiAwLjMsCiAgICAgICAgICBkYXNoQXJyYXk6IDQsCiAgICAgICAgfSwKICAgICAgfTsKICAgIH0sCiAgICBkcmF3T3B0aW9ucygpIHsKICAgICAgcmV0dXJuIHsKICAgICAgICBwb3NpdGlvbjogJ3RvcHJpZ2h0JywKICAgICAgICBkcmF3OiB7CiAgICAgICAgICBwb2x5bGluZTogZmFsc2UsCiAgICAgICAgICBjaXJjbGU6IGZhbHNlLAogICAgICAgICAgbWFya2VyOiBmYWxzZSwKICAgICAgICAgIGNpcmNsZW1hcmtlcjogZmFsc2UsCiAgICAgICAgICBwb2x5Z29uOiB7CiAgICAgICAgICAgIHNoYXBlT3B0aW9uczogewogICAgICAgICAgICAgIGNvbG9yOiB0aGlzLmFwcENvbmZpZy5icmFuZGluZy5wcmltYXJ5Q29sb3IsCiAgICAgICAgICAgIH0sCiAgICAgICAgICB9LAogICAgICAgICAgcmVjdGFuZ2xlOiB7CiAgICAgICAgICAgIHNob3dBcmVhOiBmYWxzZSwKICAgICAgICAgICAgc2hhcGVPcHRpb25zOiB7CiAgICAgICAgICAgICAgY29sb3I6IHRoaXMuYXBwQ29uZmlnLmJyYW5kaW5nLnByaW1hcnlDb2xvciwKICAgICAgICAgICAgfSwKICAgICAgICAgIH0sCiAgICAgICAgfSwKICAgICAgfTsKICAgIH0sCiAgfSwKICBtb3VudGVkKCkgewogICAgdGhpcy5kYXRhTGF5ZXJJbmRleCA9IHRoaXMudXNlZFRpbWVzLnRpbWUubGVuZ3RoIC0gMTsKICAgIHRoaXMuZGF0YUxheWVyVGltZSA9IHsgdmFsdWU6IHRoaXMudXNlZFRpbWVzLnRpbWVbdGhpcy5kYXRhTGF5ZXJJbmRleF0gfTsKICAgIHRoaXMuY29tcGFyZUxheWVyVGltZSA9IHsgdmFsdWU6IHRoaXMuZ2V0SW5pdGlhbENvbXBhcmVUaW1lKCkgfTsKICB9LAogIG1ldGhvZHM6IHsKICAgIGNyZWF0ZUxhdExuZyhsYXRsbmcpIHsKICAgICAgY29uc3QgbGxvYmogPSBsYXRsbmcuc3BsaXQoJywnKS5tYXAoTnVtYmVyKTsKICAgICAgY29uc29sZS5sb2cobGxvYmopOwogICAgICByZXR1cm4gbGxvYmo7CiAgICB9LAogICAgem9vbVVwZGF0ZWQoem9vbSkgewogICAgICB0aGlzLnpvb20gPSB6b29tOwogICAgfSwKICAgIGNlbnRlclVwZGF0ZWQoY2VudGVyKSB7CiAgICAgIHRoaXMuY2VudGVyID0gY2VudGVyOwogICAgfSwKICAgIGJvdW5kc1VwZGF0ZWQoYm91bmRzKSB7CiAgICAgIHRoaXMuYm91bmRzID0gYm91bmRzOwogICAgfSwKICAgIG9uTWFwUmVhZHkoKSB7CiAgICAgIHRoaXMubWFwID0gdGhpcy4kcmVmcy5tYXAubWFwT2JqZWN0OwogICAgICBjb25zdCBsYXllckJ1dHRvbnMgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKCcubGVhZmxldC1jb250cm9sLWxheWVycy10b2dnbGUnKTsKICAgICAgbGF5ZXJCdXR0b25zLmZvckVhY2goKGxCKSA9PiBsQi5pbm5lckhUTUwgPSBgPHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0iJHt0aGlzLmFwcENvbmZpZy5icmFuZGluZy5wcmltYXJ5Q29sb3J9IiB3aWR0aD0iMzJweCIgaGVpZ2h0PSIzMnB4Ij48cGF0aCBkPSJNMCAwaDI0djI0SDB6IiBmaWxsPSJub25lIi8+PHBhdGggZD0iTTExLjk5IDE4LjU0bC03LjM3LTUuNzNMMyAxNC4wN2w5IDcgOS03LTEuNjMtMS4yNy03LjM4IDUuNzR6TTEyIDE2bDcuMzYtNS43M0wyMSA5bC05LTctOSA3IDEuNjMgMS4yN0wxMiAxNnoiLz48L3N2Zz5gKTsgLy8gZXNsaW50LWRpc2FibGUtbGluZQogICAgICAvLyB1cGRhdGUgbGVhZmxldCBjb250cm9scwogICAgICBMLmNvbnRyb2wubW91c2VQb3NpdGlvbih7IC8vIGVzbGludC1kaXNhYmxlLWxpbmUgbm8tdW5kZWYKICAgICAgICBlbXB0eVN0cmluZzogJycsCiAgICAgICAgZm9ybWF0dGVyOiAobG9uLCBsYXQpID0+IGAke2xvbi50b0ZpeGVkKDMpfSwgJHtsYXQudG9GaXhlZCgzKX1gLAogICAgICAgIHBvc2l0aW9uOiAnYm90dG9tcmlnaHQnLAogICAgICB9KS5hZGRUbyh0aGlzLm1hcCk7CiAgICAgIC8vIGhpZGUgYXR0cmlidXRpb24gdW5kZXIgaWNvbgogICAgICB0aGlzLm1hcC5hdHRyaWJ1dGlvbkNvbnRyb2wuX3VwZGF0ZSA9IGZ1bmN0aW9uICgpIHsgLy8gZXNsaW50LWRpc2FibGUtbGluZQogICAgICAgIGNvbnN0IGF0dHJpYnMgPSBbXTsKICAgICAgICBjb25zdCBrayA9IE9iamVjdC5rZXlzKHRoaXMuX2F0dHJpYnV0aW9ucyk7CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBray5sZW5ndGg7IGkgKz0gMSkgewogICAgICAgICAgaWYgKHRoaXMuX2F0dHJpYnV0aW9uc1tra1tpXV0pIHsKICAgICAgICAgICAgYXR0cmlicy5wdXNoKGtrW2ldKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgY29uc3QgcHJlZml4QW5kQXR0cmlicyA9IFtdOwogICAgICAgIGlmICh0aGlzLm9wdGlvbnMucHJlZml4KSB7CiAgICAgICAgICBwcmVmaXhBbmRBdHRyaWJzLnB1c2godGhpcy5vcHRpb25zLnByZWZpeCk7CiAgICAgICAgfQogICAgICAgIGlmIChhdHRyaWJzLmxlbmd0aCkgewogICAgICAgICAgcHJlZml4QW5kQXR0cmlicy5wdXNoKGF0dHJpYnMuam9pbignLCAnKSk7CiAgICAgICAgfQogICAgICAgIHRoaXMuX2NvbnRhaW5lci5pbm5lckhUTUwgPSBgPGRpdiBjbGFzcz0nYXR0cmlidXRpb24tYm9keSc+JHtwcmVmaXhBbmRBdHRyaWJzLmpvaW4oJyB8ICcpfTwvZGl2PjxkaXYgY2xhc3M9J2F0dHJpYnV0aW9uLWljb24nPuKEuTwvZGl2PmA7CiAgICAgIH07CiAgICAgIHRoaXMubWFwLmF0dHJpYnV0aW9uQ29udHJvbC5fdXBkYXRlKCk7CiAgICAgIC8vIGFkZCBsb2FkaW5nIGluZGljYXRvcgogICAgICBMLkNvbnRyb2wubG9hZGluZyh7CiAgICAgICAgcG9zaXRpb246ICdib3R0b21sZWZ0JywKICAgICAgICBkZWxheUluZGljYXRvcjogMjAwLAogICAgICB9KS5hZGRUbyh0aGlzLm1hcCk7CiAgICAgIC8vIGFkZCBBL0Igc2xpZGVyCiAgICAgIGNvbnN0IGxlZnRMYXllcnMgPSB0aGlzLmV4dHJhY3RBY3R1YWxMYXllcnModGhpcy4kcmVmcy5jb21wYXJlTGF5ZXJzKTsKICAgICAgY29uc3QgcmlnaHRMYXllcnMgPSB0aGlzLmV4dHJhY3RBY3R1YWxMYXllcnModGhpcy4kcmVmcy5kYXRhTGF5ZXJzKTsKICAgICAgdGhpcy5zbGlkZXIgPSBMLmNvbnRyb2wuc2lkZUJ5U2lkZShsZWZ0TGF5ZXJzLCByaWdodExheWVycyk7CiAgICAgIHRoaXMuZHJhd0NvbnRyb2wgPSBuZXcgTC5Db250cm9sLkRyYXcodGhpcy5kcmF3T3B0aW9ucyk7CiAgICAgIHRoaXMubWFwLm9uKEwuRHJhdy5FdmVudC5DUkVBVEVELCBmdW5jdGlvbiAoZSkgeyAvLyBlc2xpbnQtZGlzYWJsZS1saW5lCiAgICAgICAgLy8gc2V0IGdsb2JhbCBhcmVhIGdlb21ldHJ5IGFzIGpzb24KICAgICAgICB0aGlzLiRzdG9yZS5jb21taXQoJ2ZlYXR1cmVzL1NFVF9TRUxFQ1RFRF9BUkVBJywgZS5sYXllci50b0dlb0pTT04oKS5nZW9tZXRyeSk7CiAgICAgIH0uYmluZCh0aGlzKSk7IC8vIGVzbGludC1kaXNhYmxlLWxpbmUKICAgICAgLy8gb25seSBkcmF3IG9uZSBmZWF0dXJlIGF0IGEgdGltZQogICAgICB0aGlzLm1hcC5vbihMLkRyYXcuRXZlbnQuRFJBV1NUQVJULCBmdW5jdGlvbiAoKSB7IC8vIGVzbGludC1kaXNhYmxlLWxpbmUKICAgICAgICB0aGlzLmNsZWFyQ3VzdG9tQXJlYUZpbHRlcigpOwogICAgICB9LmJpbmQodGhpcykpOwoKICAgICAgdGhpcy5pbml0aWFsRHJhd1NlbGVjdGVkQXJlYSgpOwogICAgICB0aGlzLm9uUmVzaXplKCk7CiAgICAgIGlmICghdGhpcy5tZXJnZWRDb25maWdzKClbMF0uY3VzdG9tQXJlYUZlYXR1cmVzIHx8IHRoaXMudmFsaWREcmF3bkFyZWEpIHsKICAgICAgICB0aGlzLmZldGNoRmVhdHVyZXMoJ2RhdGEnKTsKICAgICAgfQogICAgICBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICB0aGlzLmZseVRvQm91bmRzKCk7CiAgICAgIH0sIDEwMCk7CiAgICB9LAogICAgb25SZXNpemUoKSB7CiAgICAgIC8vIHRvIGZpeCBwYW5lbCBzaXplIGZvciByZWZlcmVuY2UgaW1hZ2Ugd2luZG93CiAgICAgIGlmICh0aGlzLm1hcCkgewogICAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgdGhpcy5tYXAuaW52YWxpZGF0ZVNpemUoKTsKICAgICAgICB9LCAxMDApOwogICAgICB9CiAgICB9LAogICAgaW5pdGlhbERyYXdTZWxlY3RlZEFyZWEoKSB7CiAgICAgIGlmICh0aGlzLmN1c3RvbUFyZWFGaWx0ZXIpIHsKICAgICAgICAvLyBhZGQgZHJhdyBjb250cm9scwogICAgICAgIHRoaXMuZHJhd0NvbnRyb2wuYWRkVG8odGhpcy5tYXApOwogICAgICAgIHRoaXMucmVuZGVyVHJhc2hCaW4gPSB0cnVlOwogICAgICAgIHRoaXMudXBkYXRlU2VsZWN0ZWRBcmVhRmVhdHVyZSgpOwogICAgICB9CiAgICB9LAogICAgdXBkYXRlU2VsZWN0ZWRBcmVhRmVhdHVyZSgpIHsKICAgICAgbGV0IGZ0cnMgPSBudWxsOwogICAgICBpZiAodGhpcy52YWxpZERyYXduQXJlYSkgewogICAgICAgIHRoaXMuZmV0Y2hGZWF0dXJlcygnZGF0YScpOwogICAgICAgIGlmICh0aGlzLmVuYWJsZUNvbXBhcmUpIHsKICAgICAgICAgIHRoaXMuZmV0Y2hGZWF0dXJlcygnY29tcGFyZScpOwogICAgICAgIH0KICAgICAgICBmdHJzID0geyAuLi50aGlzLmRyYXduQXJlYSB9OwogICAgICB9CiAgICAgIGlmIChmdHJzKSB7CiAgICAgICAgLy8gYWRkIGZlYXR1cmUgdG8gYmUgZHJhd24gaW50byBsYXllcgogICAgICAgIHRoaXMuJHJlZnMuY3VzdG9tQXJlYUZpbHRlckZlYXR1cmVzLm1hcE9iamVjdC5hZGRMYXllcihnZW9Kc29uKGZ0cnMsIHsKICAgICAgICAgIHN0eWxlOiB7CiAgICAgICAgICAgIGNvbG9yOiB0aGlzLmFwcENvbmZpZy5icmFuZGluZy5wcmltYXJ5Q29sb3IsCiAgICAgICAgICB9LAogICAgICAgIH0pKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLiRyZWZzLmN1c3RvbUFyZWFGaWx0ZXJGZWF0dXJlcy5tYXBPYmplY3QuY2xlYXJMYXllcnMoKTsKICAgICAgfQogICAgfSwKICAgIGNvdW50cmllc09wdGlvbnMoKSB7CiAgICAgIGNvbnN0IGN1cnJlbnRJbmRpY2F0b3IgPSB0aGlzLmluZGljYXRvcjsKICAgICAgcmV0dXJuIHsKICAgICAgICBvbkVhY2hGZWF0dXJlOiBmdW5jdGlvbiBvbkVhY2hGZWF0dXJlKGZlYXR1cmUsIGxheWVyKSB7CiAgICAgICAgICBsYXllci5iaW5kVG9vbHRpcCgKICAgICAgICAgICAgKCkgPT4gZmVhdHVyZS5wcm9wZXJ0aWVzLm5hbWUsCiAgICAgICAgICAgIHsgZGlyZWN0aW9uOiAndG9wJywgc3RpY2t5OiB0cnVlIH0sCiAgICAgICAgICApOwoKICAgICAgICAgIGxheWVyLm9uKCdjbGljaycsICgpID0+IHsKICAgICAgICAgICAgY29uc3QgY291bnRyeUEyID0gZmVhdHVyZS5wcm9wZXJ0aWVzLmFscGhhMjsKICAgICAgICAgICAgdGhpcy5mZXRjaE1vYmlsaXR5RGF0YShjb3VudHJ5QTIsIGN1cnJlbnRJbmRpY2F0b3IuYW9pSUQpOwogICAgICAgICAgICBpZiAodGhpcy5zZWxlY3RlZExheWVyICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgdGhpcy5zZWxlY3RlZExheWVyLnNldFN0eWxlKHsKICAgICAgICAgICAgICAgIGNvbG9yOiAnIzIyMicsCiAgICAgICAgICAgICAgICB3ZWlnaHQ6IDEsCiAgICAgICAgICAgICAgICBmaWxsQ29sb3I6ICcjZmZmJywKICAgICAgICAgICAgICAgIG9wYWNpdHk6IDEsCiAgICAgICAgICAgICAgICBmaWxsT3BhY2l0eTogMC41LAogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuc2VsZWN0ZWRDb3VudHJ5ID0gY291bnRyeUEyOwogICAgICAgICAgICB0aGlzLnNlbGVjdGVkTGF5ZXIgPSBsYXllcjsKICAgICAgICAgICAgdGhpcy5wb3B1cE5hbWUgPSBmZWF0dXJlLnByb3BlcnRpZXMubmFtZTsKICAgICAgICAgIH0pOwogICAgICAgICAgbGF5ZXIub24oJ21vdXNlb3ZlcicsIChlKSA9PiB7CiAgICAgICAgICAgIGNvbnN0IGN1cnJMYXllciA9IGUudGFyZ2V0OwogICAgICAgICAgICBjdXJyTGF5ZXIuc2V0U3R5bGUoewogICAgICAgICAgICAgIHdlaWdodDogMiwKICAgICAgICAgICAgICBjb2xvcjogdGhpcy4kdnVldGlmeS50aGVtZS5jdXJyZW50VGhlbWUucHJpbWFyeSwKICAgICAgICAgICAgICBmaWxsQ29sb3I6IHRoaXMuJHZ1ZXRpZnkudGhlbWUuY3VycmVudFRoZW1lLnByaW1hcnksCiAgICAgICAgICAgICAgZmlsbE9wYWNpdHk6IDAuNywKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICBpZiAoIUwuQnJvd3Nlci5pZSAmJiAhTC5Ccm93c2VyLm9wZXJhKSB7CiAgICAgICAgICAgICAgbGF5ZXIuYnJpbmdUb0Zyb250KCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwogICAgICAgICAgbGF5ZXIub24oJ21vdXNlb3V0JywgKGUpID0+IHsKICAgICAgICAgICAgY29uc3QgY3VyckxheWVyID0gZS50YXJnZXQ7CiAgICAgICAgICAgIGlmICh0aGlzLnNlbGVjdGVkQ291bnRyeSAhPT0gZmVhdHVyZS5wcm9wZXJ0aWVzLmFscGhhMikgewogICAgICAgICAgICAgIGN1cnJMYXllci5zZXRTdHlsZSh7CiAgICAgICAgICAgICAgICBjb2xvcjogJyMyMjInLAogICAgICAgICAgICAgICAgd2VpZ2h0OiAxLAogICAgICAgICAgICAgICAgZmlsbENvbG9yOiAnI2ZmZicsCiAgICAgICAgICAgICAgICBvcGFjaXR5OiAxLAogICAgICAgICAgICAgICAgZmlsbE9wYWNpdHk6IDAuNSwKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgfSk7CiAgICAgICAgfS5iaW5kKHRoaXMpLAogICAgICB9OwogICAgfSwKICAgIGZlYXR1cmVPcHRpb25zKHNpZGUpIHsKICAgICAgY29uc3Qgc3R5bGUgPSAodGhpcy5tZXJnZWRDb25maWdzKHNpZGUpWzBdLmZlYXR1cmVzICYmIHRoaXMubWVyZ2VkQ29uZmlncyhzaWRlKVswXS5mZWF0dXJlcy5zdHlsZSkgPyB0aGlzLm1lcmdlZENvbmZpZ3Moc2lkZSlbMF0uZmVhdHVyZXMuc3R5bGUgOiB7fTsgLy8gZXNsaW50LWRpc2FibGUtbGluZQogICAgICByZXR1cm4gewogICAgICAgIG9uRWFjaEZlYXR1cmU6IGZ1bmN0aW9uIG9uRWFjaEZlYXR1cmUoZmVhdHVyZSwgbGF5ZXIpIHsKICAgICAgICAgIC8vIGlmIGZlYXR1cmVzUGFyYW1ldGVycyBhdmFpbGFibGUsIHNob3cgb25seSBwcm9wZXJ0aWVzIGZyb20gbWFwcGluZywgb3RoZXJ3aXNlIGR1bXAgYWxsCiAgICAgICAgICBjb25zdCBhbGxvd2VkUGFyYW1zID0gdGhpcy5tZXJnZWRDb25maWdzKHNpZGUpWzBdLmZlYXR1cmVzID8gdGhpcy5tZXJnZWRDb25maWdzKHNpZGUpWzBdLmZlYXR1cmVzLmFsbG93ZWRQYXJhbWV0ZXJzIDogbnVsbDsgLy8gZXNsaW50LWRpc2FibGUtbGluZQogICAgICAgICAgY29uc3QgYWxsS2V5cyA9IE9iamVjdC5rZXlzKGZlYXR1cmUucHJvcGVydGllcyk7CiAgICAgICAgICBsZXQgdG9vbHRpcCA9ICcnOwogICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBhbGxLZXlzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIGlmICghYWxsb3dlZFBhcmFtcyB8fCAodHlwZW9mIGFsbG93ZWRQYXJhbXMgPT09ICdvYmplY3QnICYmIE9iamVjdC5rZXlzKGFsbG93ZWRQYXJhbXMpLmluY2x1ZGVzKGFsbEtleXNbaV0pKQogICAgICAgICAgICAgIHx8IChBcnJheS5pc0FycmF5KGFsbG93ZWRQYXJhbXMpICYmIGFsbG93ZWRQYXJhbXMuaW5jbHVkZXMoYWxsS2V5c1tpXSkpKSB7CiAgICAgICAgICAgICAgdG9vbHRpcCArPSBgPHNwYW4+PGI+JHthbGxLZXlzW2ldfTwvYj46ICR7ZmVhdHVyZS5wcm9wZXJ0aWVzW2FsbEtleXNbaV1dfTwvc3Bhbj48YnI+YDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKHRvb2x0aXAgIT09ICcnKSB7CiAgICAgICAgICAgIGxheWVyLmJpbmRUb29sdGlwKHRvb2x0aXAsIHsgcGFuZTogdGhpcy5wb3B1cFBhbmUgfSk7CiAgICAgICAgICB9CiAgICAgICAgICAvLyB0byBtYWtlIGNsdXN0ZXJpbmcgd29yawogICAgICAgICAgaWYgKHRoaXMubWVyZ2VkQ29uZmlncygpWzBdLmZlYXR1cmVzQ2x1c3RlcmluZykgewogICAgICAgICAgICBsYXllci5nZXRMYXRMbmcgPSAoKSA9PiBnZW9Kc29uKGZlYXR1cmUpLmdldEJvdW5kcygpLmdldENlbnRlcigpOyAvL2VzbGludC1kaXNhYmxlLWxpbmUKICAgICAgICAgICAgbGF5ZXIuc2V0TGF0TG5nID0gKCkgPT4geyB9OyAvL2VzbGludC1kaXNhYmxlLWxpbmUKICAgICAgICAgICAgbGF5ZXIuX2xhdGxuZyA9IGxheWVyLmdldExhdExuZygpOyAvL2VzbGludC1kaXNhYmxlLWxpbmUKICAgICAgICAgIH0KICAgICAgICB9LmJpbmQodGhpcyksCiAgICAgICAgLy8gcG9pbnQgY2lyY2xlIG1hcmtlciBzdHlsaW5nCiAgICAgICAgcG9pbnRUb0xheWVyOiBmdW5jdGlvbiAoZmVhdHVyZSwgbGF0bG5nKSB7IC8vIGVzbGludC1kaXNhYmxlLWxpbmUKICAgICAgICAgIHJldHVybiBjaXJjbGVNYXJrZXIobGF0bG5nLCB7CiAgICAgICAgICAgIHJhZGl1czogc3R5bGUucmFkaXVzIHx8IDgsCiAgICAgICAgICAgIGNvbG9yOiBzdHlsZS5jb2xvciB8fCAnI0ZGQTUwMCcsCiAgICAgICAgICAgIHdlaWdodDogc3R5bGUud2VpZ2h0IHx8IDIsCiAgICAgICAgICAgIG9wYWNpdHk6IHN0eWxlLm9wYWNpdHkgfHwgMSwKICAgICAgICAgICAgZGFzaEFycmF5OiBzdHlsZS5kYXNoQXJyYXkgfHwgbnVsbCwKICAgICAgICAgICAgZGFzaE9mZnNldDogc3R5bGUuZGFzaE9mZnNldCB8fCBudWxsLAogICAgICAgICAgICBmaWxsT3BhY2l0eTogc3R5bGUuZmlsbE9wYWNpdHkgfHwgMSwKICAgICAgICAgICAgZmlsbENvbG9yOiBzdHlsZS5maWxsQ29sb3IgfHwgJyNGRkE1MDAnLAogICAgICAgICAgICBmaWxsOiBzdHlsZS5maWxsIHx8IHRydWUsCiAgICAgICAgICAgIHBhbmU6IHNpZGUgPT09ICdkYXRhJyA/IHRoaXMudG9vbHRpcFBhbmUgOiB0aGlzLnNoYWRvd1BhbmUsCiAgICAgICAgICB9KTsKICAgICAgICB9LmJpbmQodGhpcyksCiAgICAgICAgLy8gcG9seWdvbiBhbmQgbGluZSBzdHlsaW5nCiAgICAgICAgc3R5bGU6IHsKICAgICAgICAgIGNvbG9yOiBzdHlsZS5jb2xvciB8fCAnI0ZGQTUwMCcsCiAgICAgICAgICB3ZWlnaHQ6IHN0eWxlLndlaWdodCB8fCAyLAogICAgICAgICAgb3BhY2l0eTogc3R5bGUub3BhY2l0eSB8fCAxLAogICAgICAgICAgZGFzaEFycmF5OiBzdHlsZS5kYXNoQXJyYXkgfHwgbnVsbCwKICAgICAgICAgIGRhc2hPZmZzZXQ6IHN0eWxlLmRhc2hPZmZzZXQgfHwgbnVsbCwKICAgICAgICAgIGZpbGxPcGFjaXR5OiBzdHlsZS5maWxsT3BhY2l0eSB8fCAwLAogICAgICAgICAgZmlsbENvbG9yOiBzdHlsZS5maWxsQ29sb3IgfHwgJyNGRkE1MDAnLAogICAgICAgICAgZmlsbDogc3R5bGUuZmlsbCB8fCB0cnVlLAogICAgICAgIH0sCiAgICAgIH07CiAgICB9LAogICAgZ2V0Q29sb3JDb2RlKHNpZGUpIHsKICAgICAgY29uc3QgaSA9IHNpZGUgPT09ICdjb21wYXJlJyA/IHRoaXMuY29tcGFyZUxheWVySW5kZXggOiB0aGlzLmRhdGFMYXllckluZGV4OwogICAgICBsZXQgY3VycmVudFZhbHVlID0gbnVsbDsKICAgICAgLy8gY29tcGVuc2F0ZSBmb3IgY29sb3IgY29kZSB3aXRoIG9ubHkgb25lIGVudHJ5LCBzdGlsbCBzaG93aW5nIGl0CiAgICAgIGlmICh0aGlzLnVzZWRUaW1lcy5jb2xvckNvZGUpIHsKICAgICAgICBjb25zdCBjb2xvcnMgPSB0aGlzLnVzZWRUaW1lcy5jb2xvckNvZGU7CiAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkoY29sb3JzKSAmJiBjb2xvcnMubGVuZ3RoID09PSAxKSB7CiAgICAgICAgICBjdXJyZW50VmFsdWUgPSBjb2xvcnNbMF07IC8vIGVzbGludC1kaXNhYmxlLWxpbmUgcHJlZmVyLWRlc3RydWN0dXJpbmcKICAgICAgICB9IGVsc2UgaWYgKEFycmF5LmlzQXJyYXkoY29sb3JzKSAmJiBjb2xvcnNbaV0pIHsKICAgICAgICAgIGN1cnJlbnRWYWx1ZSA9IGNvbG9yc1tpXTsgLy8gZXNsaW50LWRpc2FibGUtbGluZSBwcmVmZXItZGVzdHJ1Y3R1cmluZwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gY3VycmVudFZhbHVlOwogICAgfSwKICAgIGdldEFvaUZpbGwoc2lkZSkgewogICAgICBjb25zdCBjdXJyZW50VmFsdWUgPSB0aGlzLmdldENvbG9yQ29kZShzaWRlKTsKICAgICAgcmV0dXJuIGN1cnJlbnRWYWx1ZQogICAgICAgID8gdGhpcy5nZXRJbmRpY2F0b3JDb2xvcihjdXJyZW50VmFsdWUpCiAgICAgICAgOiB0aGlzLmFwcENvbmZpZy5icmFuZGluZy5wcmltYXJ5Q29sb3I7CiAgICB9LAogICAgc3ViQW9pU3R5bGUoc2lkZSkgewogICAgICBjb25zdCBjdXJyZW50VmFsdWUgPSB0aGlzLmdldENvbG9yQ29kZShzaWRlKTsKICAgICAgcmV0dXJuIHsKICAgICAgICBjb2xvcjogY3VycmVudFZhbHVlCiAgICAgICAgICA/IHRoaXMuZ2V0SW5kaWNhdG9yQ29sb3IoY3VycmVudFZhbHVlKQogICAgICAgICAgOiB0aGlzLmFwcENvbmZpZy5icmFuZGluZy5wcmltYXJ5Q29sb3IsCiAgICAgICAgd2VpZ2h0OiAzLAogICAgICAgIGZpbGw6IGZhbHNlLAogICAgICB9OwogICAgfSwKICAgIGNvbmZpZ0Zyb21JbnB1dERhdGEoc2lkZSkgewogICAgICBjb25zdCBpID0gc2lkZSA9PT0gJ2NvbXBhcmUnID8gdGhpcy5jb21wYXJlTGF5ZXJJbmRleCA6IHRoaXMuZGF0YUxheWVySW5kZXg7CiAgICAgIGNvbnN0IGlucHV0RGF0YSA9IHRoaXMudXNlZFRpbWVzLmlucHV0RGF0YS5sZW5ndGggPT09IDEKICAgICAgICA/IHRoaXMudXNlZFRpbWVzLmlucHV0RGF0YVswXQogICAgICAgIDogdGhpcy51c2VkVGltZXMuaW5wdXREYXRhW2ldOwogICAgICBpZiAodGhpcy5iYXNlQ29uZmlnLmxheWVyTmFtZU1hcHBpbmcuaGFzT3duUHJvcGVydHkoaW5wdXREYXRhKSkgeyAvLyBlc2xpbnQtZGlzYWJsZS1saW5lCiAgICAgICAgbGV0IGNvbmZpZyA9IHRoaXMuYmFzZUNvbmZpZy5sYXllck5hbWVNYXBwaW5nW2lucHV0RGF0YV07CiAgICAgICAgaWYgKCFBcnJheS5pc0FycmF5KGNvbmZpZykpIHsKICAgICAgICAgIC8vIGFzc3VyZSBhcnJheSBpcyByZXR1cm5lZAogICAgICAgICAgY29uZmlnID0gW2NvbmZpZ107CiAgICAgICAgfQogICAgICAgIHJldHVybiBjb25maWc7CiAgICAgIH0KICAgICAgLy8gZW1wdHkgY29uZmlnIHVzZWQgbGF0ZXIgZm9yIG1lcmdpbmcKICAgICAgcmV0dXJuIFtdOwogICAgfSwKICAgIGdldENvbWJpbmVkV01TTGF5ZXJzKHNpZGUpIHsKICAgICAgY29uc3QgY29tYkxheWVycyA9IHRoaXMubWVyZ2VkQ29uZmlncyhzaWRlKS5maWx0ZXIoKGwpID0+ICgKICAgICAgICBsLnByb3RvY29sID09PSAnV01TJyAmJiBPYmplY3Qua2V5cyhsKS5pbmRleE9mKCdjb21iaW5lZExheWVycycpICE9PSAtMQogICAgICApKTsKICAgICAgcmV0dXJuIGNvbWJMYXllcnM7CiAgICB9LAogICAgZ2V0U2ltcGxlV01TTGF5ZXJzKHNpZGUpIHsKICAgICAgY29uc3QgY29tYkxheWVycyA9IHRoaXMubWVyZ2VkQ29uZmlncyhzaWRlKS5maWx0ZXIoKGwpID0+ICgKICAgICAgICBsLnByb3RvY29sID09PSAnV01TJyAmJiBPYmplY3Qua2V5cyhsKS5pbmRleE9mKCdjb21iaW5lZExheWVycycpID09PSAtMQogICAgICApKTsKICAgICAgcmV0dXJuIGNvbWJMYXllcnM7CiAgICB9LAogICAgbWVyZ2VkQ29uZmlncyhzaWRlID0gJ2RhdGEnKSB7CiAgICAgIC8vIGZpcnN0IGNoZWNrIGlmIHNwZWNpYWwgY29tcGFyZSBsYXllciBjb25maWd1cmVkCiAgICAgIGxldCBkaXNwbGF5VG1wID0gc2lkZSA9PT0gJ2NvbXBhcmUnICYmIHRoaXMuaW5kaWNhdG9yLmNvbXBhcmVEaXNwbGF5ID8gdGhpcy5pbmRpY2F0b3IuY29tcGFyZURpc3BsYXkgOiB0aGlzLmluZGljYXRvci5kaXNwbGF5OwogICAgICAvLyBmb2xsb3dpbmcgY29uZmlndXJhdGlvbiBtZXJnaW5nIGlzIGRvbmU6CiAgICAgIC8vIGRlZmF1bHRMYXllcnNEaXNwbGF5ICh0byBhdm9pZCBoYXZpbmcgdG8gY29uZmlndXJlIGl0IGJlZm9yZSkKICAgICAgLy8gaW5kRGVmaW5pdGlvbiAtIGluZGljYXRvciBjb2RlIHNwZWNpZmljIGNvbmZpZ3VyYXRpb24KICAgICAgLy8gZGlzcGxheSAtIGNvbWluZyBmcm9tIGpzIGNvbmZpZ3VyYXRpb24gLSBlc2EuanMgT1IKICAgICAgLy8gY29uZmlnRnJvbUlucHV0RGF0YSAtIGNvbWluZyBmcm9tIGlucHV0IGRhdGEgcmVmZXJlbmNlIGZyb20gY3N2cwoKICAgICAgaWYgKGRpc3BsYXlUbXApIHsKICAgICAgICAvLyBmcm9tIGxheWVyIGNvbmZpZ3VyYXRpb24KICAgICAgICBpZiAoIUFycmF5LmlzQXJyYXkoZGlzcGxheVRtcCkpIHsKICAgICAgICAgIC8vIGFsd2F5cyBtYWtlIGFuIEFycmF5IG9mIGxheWVyIGNvbmZpZ3VyYXRpb25zCiAgICAgICAgICBkaXNwbGF5VG1wID0gW2Rpc3BsYXlUbXBdOwogICAgICAgIH0KICAgICAgfQogICAgICBjb25zdCBmaW5hbENvbmZpZ3MgPSBbXTsKICAgICAgbGV0IHVzZWRDb25maWdGb3JNZXJnZSA9IHt9OwogICAgICBsZXQgbmFtZSA9IHRoaXMuaW5kaWNhdG9yLmRlc2NyaXB0aW9uOwoKICAgICAgaWYgKCFkaXNwbGF5VG1wICYmIHRoaXMuY29uZmlnRnJvbUlucHV0RGF0YShzaWRlKS5sZW5ndGggPT09IDApIHsKICAgICAgICAvLyBubyBhZGRpdGlvbmFsIGNvbmZpZyBzcGVjaWZpZWQsIHVzZSBkZWZhdWx0cwogICAgICAgIHVzZWRDb25maWdGb3JNZXJnZSA9IFt7IG5hbWUgfV07CiAgICAgIH0gZWxzZSBpZiAoIWRpc3BsYXlUbXApIHsKICAgICAgICAvLyB1c2UgY29uZmlnRnJvbUlucHV0RGF0YQogICAgICAgIHVzZWRDb25maWdGb3JNZXJnZSA9IHRoaXMuY29uZmlnRnJvbUlucHV0RGF0YShzaWRlKTsKICAgICAgfSBlbHNlIHsKICAgICAgICAvLyB1c2UgZGlzcGxheVRtcCBldmVuIGlmIGNvbmZpZ0Zyb21JbnB1dERhdGEgc2V0IHRvbwogICAgICAgIHVzZWRDb25maWdGb3JNZXJnZSA9IGRpc3BsYXlUbXA7CiAgICAgIH0KICAgICAgdXNlZENvbmZpZ0Zvck1lcmdlLmZvckVhY2goKGl0ZW0pID0+IHsKICAgICAgICAvLyBtZXJnZSBjb25maWdzIGZvciBlYWNoIGxheWVyCiAgICAgICAgbmFtZSA9IGl0ZW0ubmFtZSB8fCBuYW1lOwogICAgICAgIC8vIENoZWNrIHRvIHNlZSBpZiB3ZSBoYXZlIGdyb3VwZWQgbGF5ZXJzLCBpZiB3ZSBkbyB3ZSBuZWVkIHRvIGFkZAogICAgICAgIC8vIHRoZSBkZWZhdWx0IHRvIHRoZW0gdG9vCiAgICAgICAgY29uc3QgZXh0ZW5kZWRJdGVtID0gaXRlbTsKICAgICAgICBpZiAoT2JqZWN0LmtleXMoaXRlbSkuaW5kZXhPZignY29tYmluZWRMYXllcnMnKSAhPT0gLTEpIHsKICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgaXRlbS5jb21iaW5lZExheWVycy5sZW5ndGg7IGkgKz0gMSkgewogICAgICAgICAgICBleHRlbmRlZEl0ZW0uY29tYmluZWRMYXllcnNbaV0gPSB7CiAgICAgICAgICAgICAgLi4udGhpcy5iYXNlQ29uZmlnLmRlZmF1bHRMYXllcnNEaXNwbGF5LAogICAgICAgICAgICAgIC4uLnRoaXMuaW5kRGVmaW5pdGlvbiwKICAgICAgICAgICAgICAuLi5pdGVtLmNvbWJpbmVkTGF5ZXJzW2ldLAogICAgICAgICAgICB9OwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmaW5hbENvbmZpZ3MucHVzaCh7CiAgICAgICAgICAuLi50aGlzLmJhc2VDb25maWcuZGVmYXVsdExheWVyc0Rpc3BsYXksCiAgICAgICAgICAuLi50aGlzLmluZERlZmluaXRpb24sCiAgICAgICAgICAuLi5leHRlbmRlZEl0ZW0sCiAgICAgICAgICBuYW1lLAogICAgICAgIH0pOwogICAgICB9KTsKICAgICAgcmV0dXJuIGZpbmFsQ29uZmlnczsKICAgIH0sCiAgICBmbHlUb0JvdW5kcygpIHsKICAgICAgLy8gem9vbXMgdG8gc3ViYW9pIGlmIHByZXNlbnQgb3IgYXJlYSBhcm91bmQgYW9pIGlmIG5vdAogICAgICBjb25zdCBib3VuZHNQYWQgPSB0aGlzLm1lcmdlZENvbmZpZ3MoKVswXS5sYXJnZVN1YkFvaSA/IDUgOiAodGhpcy5tZXJnZWRDb25maWdzKClbMF0ubWlkU3ViQW9pID8gMSA6IDAuMTUpOyAvLyBlc2xpbnQtZGlzYWJsZS1saW5lCiAgICAgIGlmICh0aGlzLnN1YkFvaSAmJiB0aGlzLnN1YkFvaS5mZWF0dXJlcy5sZW5ndGggPiAwKSB7CiAgICAgICAgY29uc3Qgdmlld0JvdW5kcyA9IHRoaXMubWVyZ2VkQ29uZmlncygpWzBdLnByZXNldFZpZXcKICAgICAgICAgID8gZ2VvSnNvbih0aGlzLm1lcmdlZENvbmZpZ3MoKVswXS5wcmVzZXRWaWV3KS5nZXRCb3VuZHMoKQogICAgICAgICAgOiBnZW9Kc29uKHRoaXMuc3ViQW9pKS5nZXRCb3VuZHMoKTsKICAgICAgICBjb25zdCBib3VuZHMgPSBnZW9Kc29uKHRoaXMuc3ViQW9pKS5nZXRCb3VuZHMoKTsKICAgICAgICBjb25zdCBjb3JuZXJNYXgxID0gbGF0TG5nKFtib3VuZHMuZ2V0U291dGgoKSAtIGJvdW5kc1BhZCwgYm91bmRzLmdldFdlc3QoKSAtIGJvdW5kc1BhZF0pOwogICAgICAgIGNvbnN0IGNvcm5lck1heDIgPSBsYXRMbmcoW2JvdW5kcy5nZXROb3J0aCgpICsgYm91bmRzUGFkLCBib3VuZHMuZ2V0RWFzdCgpICsgYm91bmRzUGFkXSk7CiAgICAgICAgY29uc3QgYm91bmRzTWF4ID0gbGF0TG5nQm91bmRzKGNvcm5lck1heDEsIGNvcm5lck1heDIpOwogICAgICAgIHRoaXMubWFwLmZpdEJvdW5kcyh2aWV3Qm91bmRzKTsKICAgICAgICAvLyBsaW1pdCB1c2VyIG1vdmVtZW50IGFyb3VuZCBtYXAKICAgICAgICB0aGlzLm1hcC5zZXRNYXhCb3VuZHMoYm91bmRzTWF4KTsKICAgICAgICBpZiAodGhpcy5tZXJnZWRDb25maWdzKClbMF0ubGFyZ2VTdWJBb2kpIHsKICAgICAgICAgIHRoaXMubWFwLnNldE1pblpvb20oMik7CiAgICAgICAgfSBlbHNlIGlmICh0aGlzLm1lcmdlZENvbmZpZ3MoKVswXS5taWRTdWJBb2kpIHsKICAgICAgICAgIHRoaXMubWFwLnNldE1pblpvb20oOSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHRoaXMubWFwLnNldE1pblpvb20oMTMpOwogICAgICAgIH0KICAgICAgfSBlbHNlIGlmICh0aGlzLm1lcmdlZENvbmZpZ3MoKVswXS5wcmVzZXRWaWV3KSB7CiAgICAgICAgLy8gaWYgb25seSBwcmVzZXQgdmlldyBtb3ZlIG1hcCB0aGVyZSB3aXRob3V0IGxpbWl0aW5nIG1vdmVtZW50CiAgICAgICAgY29uc3Qgdmlld0JvdW5kcyA9IGdlb0pzb24odGhpcy5tZXJnZWRDb25maWdzKClbMF0ucHJlc2V0VmlldykuZ2V0Qm91bmRzKCk7CiAgICAgICAgdGhpcy5tYXAuZml0Qm91bmRzKHZpZXdCb3VuZHMpOwogICAgICB9IGVsc2UgaWYgKHRoaXMuYW9pKSB7CiAgICAgICAgY29uc3QgY29ybmVyTWF4MSA9IGxhdExuZyhbdGhpcy5hb2kubGF0IC0gYm91bmRzUGFkLCB0aGlzLmFvaS5sbmcgLSBib3VuZHNQYWRdKTsKICAgICAgICBjb25zdCBjb3JuZXJNYXgyID0gbGF0TG5nKFt0aGlzLmFvaS5sYXQgKyBib3VuZHNQYWQsIHRoaXMuYW9pLmxuZyArIGJvdW5kc1BhZF0pOwogICAgICAgIGNvbnN0IGJvdW5kc01heCA9IGxhdExuZ0JvdW5kcyhjb3JuZXJNYXgxLCBjb3JuZXJNYXgyKTsKICAgICAgICB0aGlzLm1hcC5zZXRab29tKDE2KTsKICAgICAgICB0aGlzLm1hcC5wYW5Ubyh0aGlzLmFvaSk7CiAgICAgICAgaWYgKHRoaXMubWVyZ2VkQ29uZmlncygpWzBdLmxhcmdlU3ViQW9pKSB7CiAgICAgICAgICB0aGlzLm1hcC5zZXRNaW5ab29tKDIpOwogICAgICAgIH0gZWxzZSBpZiAodGhpcy5tZXJnZWRDb25maWdzKClbMF0ubWlkU3ViQW9pKSB7CiAgICAgICAgICB0aGlzLm1hcC5zZXRNaW5ab29tKDkpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0aGlzLm1hcC5zZXRNaW5ab29tKDEyKTsKICAgICAgICB9CiAgICAgICAgLy8gbGltaXQgdXNlciBtb3ZlbWVudCBhcm91bmQgbWFwCiAgICAgICAgdGhpcy5tYXAuc2V0TWF4Qm91bmRzKGJvdW5kc01heCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgLy8gem9vbSB0byBkZWZhdWx0IGJib3ggZnJvbSBjb25maWcKICAgICAgICB0aGlzLm1hcC5zZXRNaW5ab29tKHRoaXMubWFwRGVmYXVsdHMubWluTWFwWm9vbSk7CiAgICAgICAgdGhpcy5tYXAuc2V0TWF4Qm91bmRzKG51bGwpOwogICAgICAgIHRoaXMubWFwLmZpdEJvdW5kcyhsYXRMbmdCb3VuZHModGhpcy5tYXBEZWZhdWx0cy5ib3VuZHMpKTsKICAgICAgfQogICAgfSwKICAgIGdldFRpbWVMYWJlbCh0aW1lKSB7CiAgICAgIGlmIChBcnJheS5pc0FycmF5KHRpbWUpICYmIHRpbWUubGVuZ3RoID09PSAyKSB7CiAgICAgICAgLy8gc2hvdyBzdGFydCAtIGVuZAogICAgICAgIGlmICh0aGlzLm1lcmdlZENvbmZpZ3MoKVswXS5tYXBUaW1lTGFiZWxFeHRlbmRlZCkgewogICAgICAgICAgcmV0dXJuIHRpbWUubWFwKChkKSA9PiBEYXRlVGltZS5mcm9tSVNPKGQpLnRvSVNPKHsgc3VwcHJlc3NNaWxsaXNlY29uZHM6IHRydWUgfSkpLmpvaW4oJyAtICcpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdGltZS5tYXAoKGQpID0+IERhdGVUaW1lLmZyb21JU08oZCkudG9JU09EYXRlKCkpLmpvaW4oJyAtICcpOwogICAgICB9IGVsc2UgaWYgKHRpbWUgaW5zdGFuY2VvZiBEYXRlVGltZSkgeyAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIG5vLWVsc2UtcmV0dXJuCiAgICAgICAgaWYgKHRoaXMubWVyZ2VkQ29uZmlncygpWzBdLm1hcFRpbWVMYWJlbEV4dGVuZGVkKSB7CiAgICAgICAgICByZXR1cm4gdGltZS50b0lTTyh7IHN1cHByZXNzTWlsbGlzZWNvbmRzOiB0cnVlIH0pOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdGltZS50b0lTT0RhdGUoKTsKICAgICAgfQogICAgICBpZiAodGhpcy5tZXJnZWRDb25maWdzKClbMF0ubWFwVGltZUxhYmVsRXh0ZW5kZWQpIHsKICAgICAgICByZXR1cm4gRGF0ZVRpbWUuZnJvbUlTTyh0aW1lKS50b0lTTyh7IHN1cHByZXNzTWlsbGlzZWNvbmRzOiB0cnVlIH0pOwogICAgICB9CiAgICAgIHJldHVybiBEYXRlVGltZS5mcm9tSVNPKHRpbWUpLnRvSVNPRGF0ZSgpOwogICAgfSwKICAgIGxheWVyT3B0aW9ucyh0aW1lLCBzb3VyY2VPcHRpb25zT2JqKSB7CiAgICAgIGNvbnN0IGFkZGl0aW9uYWxTZXR0aW5ncyA9IHt9OwogICAgICBpZiAoT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHNvdXJjZU9wdGlvbnNPYmosICdzaXRlTWFwcGluZycpKSB7CiAgICAgICAgY29uc3QgY3VyclNpdGUgPSBzb3VyY2VPcHRpb25zT2JqLnNpdGVNYXBwaW5nKAogICAgICAgICAgdGhpcy5pbmRpY2F0b3IuYW9pSUQsCiAgICAgICAgKTsKICAgICAgICBhZGRpdGlvbmFsU2V0dGluZ3Muc2l0ZSA9IGN1cnJTaXRlOwogICAgICB9CiAgICAgIGlmICh0eXBlb2Ygc291cmNlT3B0aW9uc09iai5taW5ab29tICE9PSAndW5kZWZpbmVkJykgewogICAgICAgIGFkZGl0aW9uYWxTZXR0aW5ncy5taW5ab29tID0gc291cmNlT3B0aW9uc09iai5taW5ab29tOwogICAgICB9CiAgICAgIGlmICh0eXBlb2Ygc291cmNlT3B0aW9uc09iai5tYXhab29tICE9PSAndW5kZWZpbmVkJykgewogICAgICAgIGFkZGl0aW9uYWxTZXR0aW5ncy5tYXhab29tID0gc291cmNlT3B0aW9uc09iai5tYXhab29tOwogICAgICB9CiAgICAgIGlmICh0eXBlb2Ygc291cmNlT3B0aW9uc09iai5taW5OYXRpdmVab29tICE9PSAndW5kZWZpbmVkJykgewogICAgICAgIGFkZGl0aW9uYWxTZXR0aW5ncy5taW5OYXRpdmVab29tID0gc291cmNlT3B0aW9uc09iai5taW5OYXRpdmVab29tOwogICAgICB9CiAgICAgIGlmICh0eXBlb2Ygc291cmNlT3B0aW9uc09iai5tYXhOYXRpdmVab29tICE9PSAndW5kZWZpbmVkJykgewogICAgICAgIGFkZGl0aW9uYWxTZXR0aW5ncy5tYXhOYXRpdmVab29tID0gc291cmNlT3B0aW9uc09iai5tYXhOYXRpdmVab29tOwogICAgICB9CiAgICAgIGlmICh0eXBlb2Ygc291cmNlT3B0aW9uc09iai5ib3VuZHMgIT09ICd1bmRlZmluZWQnKSB7CiAgICAgICAgYWRkaXRpb25hbFNldHRpbmdzLmJvdW5kcyA9IHNvdXJjZU9wdGlvbnNPYmouYm91bmRzOwogICAgICB9CiAgICAgIGlmICh0aW1lICE9PSBudWxsKSB7CiAgICAgICAgLy8gdGltZSBhcyBpcyBnZXRzIGF1dG9tYXRpY2FsbHkgaW5qZWN0ZWQgdG8gV01TIHF1ZXJ5IE9SIHh5eiB1cmwge3RpbWV9IHRlbXBsYXRlCiAgICAgICAgY29uc3QgZml4VGltZSA9IHRpbWUudmFsdWUgfHwgdGltZTsKICAgICAgICBhZGRpdGlvbmFsU2V0dGluZ3MudGltZSA9IHR5cGVvZiBzb3VyY2VPcHRpb25zT2JqLmRhdGVGb3JtYXRGdW5jdGlvbiA9PT0gJ2Z1bmN0aW9uJwogICAgICAgICAgPyBzb3VyY2VPcHRpb25zT2JqLmRhdGVGb3JtYXRGdW5jdGlvbihmaXhUaW1lKSA6IGZpeFRpbWU7CiAgICAgICAgaWYgKHNvdXJjZU9wdGlvbnNPYmouZmVhdHVyZXMpIHsKICAgICAgICAgIGFkZGl0aW9uYWxTZXR0aW5ncy5mZWF0dXJlc1RpbWUgPSB0eXBlb2Ygc291cmNlT3B0aW9uc09iai5mZWF0dXJlcy5kYXRlRm9ybWF0RnVuY3Rpb24gPT09ICdmdW5jdGlvbicKICAgICAgICAgICAgPyBzb3VyY2VPcHRpb25zT2JqLmZlYXR1cmVzLmRhdGVGb3JtYXRGdW5jdGlvbihmaXhUaW1lKSA6IGZpeFRpbWU7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiBhZGRpdGlvbmFsU2V0dGluZ3M7CiAgICB9LAogICAgZGF0YUxheWVyVGltZVNlbGVjdGlvbihwYXlsb2FkKSB7CiAgICAgIC8vIERpZmZlcmVudCBvYmplY3QgcmV0dXJuZWQgZWl0aGVyIGJ5IGFycm93IHVzZSBvciBieSBkcm9wZG93biB1c2UKICAgICAgaWYgKEFycmF5LmlzQXJyYXkocGF5bG9hZCkgfHwgIShwYXlsb2FkLnZhbHVlKSkgewogICAgICAgIHRoaXMuZGF0YUxheWVyVGltZSA9IHsgdmFsdWU6IHBheWxvYWQsIG5hbWU6IGAke3BheWxvYWR9YCB9OwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMuZGF0YUxheWVyVGltZSA9IHBheWxvYWQ7CiAgICAgIH0KICAgICAgY29uc3QgbmV3SW5kZXggPSB0aGlzLmFycmF5T2ZPYmplY3RzCiAgICAgICAgLm1hcCgoaSkgPT4gaS52YWx1ZSkKICAgICAgICAuaW5kZXhPZih0aGlzLmRhdGFMYXllclRpbWUudmFsdWUgPyB0aGlzLmRhdGFMYXllclRpbWUudmFsdWUgOiB0aGlzLmRhdGFMYXllclRpbWUpOwogICAgICB0aGlzLmRhdGFMYXllckluZGV4ID0gbmV3SW5kZXg7CiAgICAgIHRoaXMucmVmcmVzaExheWVycygnZGF0YScpOwogICAgICB0aGlzLiRuZXh0VGljaygoKSA9PiB7CiAgICAgICAgdGhpcy5zbGlkZXIuc2V0UmlnaHRMYXllcnMoCiAgICAgICAgICB0aGlzLmV4dHJhY3RBY3R1YWxMYXllcnModGhpcy4kcmVmcy5kYXRhTGF5ZXJzKSwKICAgICAgICApOwogICAgICB9KTsKICAgICAgaWYgKHRoaXMuaW5kaWNhdG9yLmNvbXBhcmVEaXNwbGF5KSB7CiAgICAgICAgLy8gc2hhcmVkIHRpbWUgb24gYm90aCBzaWRlcyBpbiBjYXNlIG9mIGNvbXBhcmVEaXNwbGF5IGJlaW5nIHNldAogICAgICAgIHRoaXMuY29tcGFyZUxheWVyVGltZSA9IHRoaXMuZGF0YUxheWVyVGltZTsKICAgICAgICB0aGlzLmNvbXBhcmVMYXllckluZGV4ID0gbmV3SW5kZXg7CiAgICAgICAgdGhpcy5yZWZyZXNoTGF5ZXJzKCdjb21wYXJlJyk7CiAgICAgICAgdGhpcy4kbmV4dFRpY2soKCkgPT4gewogICAgICAgICAgdGhpcy5zbGlkZXIuc2V0TGVmdExheWVycygKICAgICAgICAgICAgdGhpcy5leHRyYWN0QWN0dWFsTGF5ZXJzKHRoaXMuJHJlZnMuY29tcGFyZUxheWVycyksCiAgICAgICAgICApOwogICAgICAgIH0pOwogICAgICB9CiAgICB9LAogICAgZXh0cmFjdEFjdHVhbExheWVycyhncm91cCkgewogICAgICBsZXQgYWN0dWFsTGF5ZXJzID0gW107CiAgICAgIGlmIChncm91cC4kY2hpbGRyZW4ubGVuZ3RoID4gMCkgewogICAgICAgIGdyb3VwLiRjaGlsZHJlbi5mb3JFYWNoKChjaGlsZCkgPT4gewogICAgICAgICAgYWN0dWFsTGF5ZXJzID0gYWN0dWFsTGF5ZXJzLmNvbmNhdCh0aGlzLmV4dHJhY3RBY3R1YWxMYXllcnMoY2hpbGQpKTsKICAgICAgICB9KTsKICAgICAgfSBlbHNlIHsKICAgICAgICBhY3R1YWxMYXllcnMucHVzaChncm91cC5tYXBPYmplY3QpOwogICAgICB9CiAgICAgIHJldHVybiBhY3R1YWxMYXllcnM7CiAgICB9LAogICAgY29tcGFyZUxheWVyVGltZVNlbGVjdGlvbihwYXlsb2FkKSB7CiAgICAgIC8vIERpZmZlcmVudCBvYmplY3QgcmV0dXJuZWQgZWl0aGVyIGJ5IGFycm93IHVzZSBvciBieSBkcm9wZG93biB1c2UKICAgICAgaWYgKEFycmF5LmlzQXJyYXkocGF5bG9hZCkgfHwgIShwYXlsb2FkLnZhbHVlKSkgewogICAgICAgIHRoaXMuY29tcGFyZUxheWVyVGltZSA9IHsgdmFsdWU6IHBheWxvYWQsIG5hbWU6IGAke3BheWxvYWR9YCB9OwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMuY29tcGFyZUxheWVyVGltZSA9IHBheWxvYWQ7CiAgICAgIH0KICAgICAgY29uc3QgbmV3SW5kZXggPSB0aGlzLmFycmF5T2ZPYmplY3RzCiAgICAgICAgLm1hcCgoaSkgPT4gaS52YWx1ZSkKICAgICAgICAuaW5kZXhPZih0aGlzLmNvbXBhcmVMYXllclRpbWUudmFsdWUgPyB0aGlzLmNvbXBhcmVMYXllclRpbWUudmFsdWUgOiB0aGlzLmNvbXBhcmVMYXllclRpbWUpOwogICAgICB0aGlzLmNvbXBhcmVMYXllckluZGV4ID0gbmV3SW5kZXg7CiAgICAgIHRoaXMucmVmcmVzaExheWVycygnY29tcGFyZScpOwogICAgICB0aGlzLiRuZXh0VGljaygoKSA9PiB7CiAgICAgICAgdGhpcy5zbGlkZXIuc2V0TGVmdExheWVycygKICAgICAgICAgIHRoaXMuZXh0cmFjdEFjdHVhbExheWVycyh0aGlzLiRyZWZzLmNvbXBhcmVMYXllcnMpLAogICAgICAgICk7CiAgICAgIH0pOwogICAgfSwKICAgIGRhdGFMYXllclJlZHVjZSgpIHsKICAgICAgY29uc3QgY3VycmVudEluZGV4ID0gdGhpcy5hcnJheU9mT2JqZWN0cwogICAgICAgIC5tYXAoKGkpID0+IGkudmFsdWUpCiAgICAgICAgLmluZGV4T2YodGhpcy5kYXRhTGF5ZXJUaW1lLnZhbHVlID8gdGhpcy5kYXRhTGF5ZXJUaW1lLnZhbHVlIDogdGhpcy5kYXRhTGF5ZXJUaW1lKTsKICAgICAgdGhpcy5kYXRhTGF5ZXJJbmRleCA9IGN1cnJlbnRJbmRleCAtIDE7CiAgICAgIHRoaXMuZGF0YUxheWVyVGltZVNlbGVjdGlvbih0aGlzLmFycmF5T2ZPYmplY3RzW2N1cnJlbnRJbmRleCAtIDFdKTsKICAgIH0sCiAgICBkYXRhTGF5ZXJJbmNyZWFzZSgpIHsKICAgICAgY29uc3QgY3VycmVudEluZGV4ID0gdGhpcy5hcnJheU9mT2JqZWN0cwogICAgICAgIC5tYXAoKGkpID0+IGkudmFsdWUpCiAgICAgICAgLmluZGV4T2YodGhpcy5kYXRhTGF5ZXJUaW1lLnZhbHVlID8gdGhpcy5kYXRhTGF5ZXJUaW1lLnZhbHVlIDogdGhpcy5kYXRhTGF5ZXJUaW1lKTsKICAgICAgdGhpcy5kYXRhTGF5ZXJJbmRleCA9IGN1cnJlbnRJbmRleCArIDE7CiAgICAgIHRoaXMuZGF0YUxheWVyVGltZVNlbGVjdGlvbih0aGlzLmFycmF5T2ZPYmplY3RzW2N1cnJlbnRJbmRleCArIDFdKTsKICAgIH0sCiAgICBjb21wYXJlTGF5ZXJSZWR1Y2UoKSB7CiAgICAgIGNvbnN0IGN1cnJlbnRJbmRleCA9IHRoaXMuYXJyYXlPZk9iamVjdHMKICAgICAgICAubWFwKChpKSA9PiBpLnZhbHVlKQogICAgICAgIC5pbmRleE9mKHRoaXMuY29tcGFyZUxheWVyVGltZS52YWx1ZSA/IHRoaXMuY29tcGFyZUxheWVyVGltZS52YWx1ZSA6IHRoaXMuY29tcGFyZUxheWVyVGltZSk7CiAgICAgIHRoaXMuY29tcGFyZUxheWVySW5kZXggPSBjdXJyZW50SW5kZXggLSAxOwogICAgICB0aGlzLmNvbXBhcmVMYXllclRpbWVTZWxlY3Rpb24odGhpcy5hcnJheU9mT2JqZWN0c1tjdXJyZW50SW5kZXggLSAxXSk7CiAgICB9LAogICAgY29tcGFyZUxheWVySW5jcmVhc2UoKSB7CiAgICAgIGNvbnN0IGN1cnJlbnRJbmRleCA9IHRoaXMuYXJyYXlPZk9iamVjdHMKICAgICAgICAubWFwKChpKSA9PiBpLnZhbHVlKQogICAgICAgIC5pbmRleE9mKHRoaXMuY29tcGFyZUxheWVyVGltZS52YWx1ZSA/IHRoaXMuY29tcGFyZUxheWVyVGltZS52YWx1ZSA6IHRoaXMuY29tcGFyZUxheWVyVGltZSk7CiAgICAgIHRoaXMuY29tcGFyZUxheWVySW5kZXggPSBjdXJyZW50SW5kZXggKyAxOwogICAgICB0aGlzLmNvbXBhcmVMYXllclRpbWVTZWxlY3Rpb24odGhpcy5hcnJheU9mT2JqZWN0c1tjdXJyZW50SW5kZXggKyAxXSk7CiAgICB9LAogICAgZ2V0SW5pdGlhbENvbXBhcmVUaW1lKCkgewogICAgICAvLyBmaW5kIGNsb3Nlc3QgZW50cnkgb25lIHllYXIgYmVmb3JlIGxhdGVzdCB0aW1lCiAgICAgIGlmICh0aGlzLm1lcmdlZENvbmZpZ3MoKVswXS5sYXJnZVRpbWVEdXJhdGlvbikgewogICAgICAgIC8vIGlmIGludGVydmFsLCB1c2UganVzdCBzdGFydCB0byBnZXQgY2xvc2VzdAogICAgICAgIGNvbnN0IHRpbWVzID0gdGhpcy51c2VkVGltZXMudGltZS5tYXAoKGl0ZW0pID0+IChBcnJheS5pc0FycmF5KGl0ZW0pID8gaXRlbVswXSA6IGl0ZW0pKTsKICAgICAgICBjb25zdCBsYXN0VGltZUVudHJ5ID0gRGF0ZVRpbWUuZnJvbUlTTyh0aW1lc1t0aW1lcy5sZW5ndGggLSAxXSk7CiAgICAgICAgY29uc3Qgb25lWWVhckJlZm9yZSA9IGxhc3RUaW1lRW50cnkubWludXMoeyB5ZWFyczogMSB9KTsKICAgICAgICAvLyBzZWxlY3QgY2xvc2VzdCB0byBvbmUgeWVhciBiZWZvcmUKICAgICAgICBjb25zdCBjbG9zZXN0T25lWWVhckJlZm9yZSA9IHRpbWVzLmZpbmQoKGl0ZW0sIGkpID0+ICgKICAgICAgICAgIGkgPT09IHRpbWVzLmxlbmd0aCAtIDEgfHwgKAogICAgICAgICAgICBNYXRoLmFicyhvbmVZZWFyQmVmb3JlLnRvTWlsbGlzKCkgLSBEYXRlVGltZS5mcm9tSVNPKGl0ZW0pLnRvTWlsbGlzKCkpCiAgICAgICAgICAgIDwgTWF0aC5hYnMob25lWWVhckJlZm9yZS50b01pbGxpcygpIC0gRGF0ZVRpbWUuZnJvbUlTTyh0aW1lc1tpICsgMV0pLnRvTWlsbGlzKCkpCiAgICAgICAgICApCiAgICAgICAgKSk7CiAgICAgICAgLy8gR2V0IGluZGV4IGFuZCByZXR1cm4gb2JqZWN0IGZyb20gb3JpZ2luYWwgdGltZXMgYXMgdGhlcmUgYXJlIGFsc28KICAgICAgICAvLyBhcnJheXMgb2YgdGltZSB0dXBsZSBhcnJheXMKICAgICAgICBjb25zdCBmb3VuZEluZGV4ID0gdGltZXMuaW5kZXhPZihjbG9zZXN0T25lWWVhckJlZm9yZSk7CiAgICAgICAgcmV0dXJuIHRoaXMudXNlZFRpbWVzLnRpbWVbZm91bmRJbmRleF07CiAgICAgIH0KICAgICAgLy8gdXNlIGZpcnN0IHRpbWUKICAgICAgcmV0dXJuIHRoaXMudXNlZFRpbWVzLnRpbWVbMF07CiAgICB9LAogICAgcmVmcmVzaEdyb3VwKGdyb3VwLCB0aW1lKSB7CiAgICAgIC8vIEdyb3VwIGNhbiBhbHNvIGJlIGFuIGFycmF5IGRlcGVuZGluZyBvbiB0eXBlCiAgICAgIGlmIChncm91cCkgewogICAgICAgIGxldCB0b0l0ZXJhdGU7CiAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkoZ3JvdXApKSB7CiAgICAgICAgICB0b0l0ZXJhdGUgPSBncm91cDsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdG9JdGVyYXRlID0gZ3JvdXAuJGNoaWxkcmVuOwogICAgICAgIH0KICAgICAgICBpZiAodG9JdGVyYXRlKSB7CiAgICAgICAgICB0b0l0ZXJhdGUuZm9yRWFjaCgoaXRlbSkgPT4gewogICAgICAgICAgICAvLyBXZSBjaGVjayBpZiB3ZSBoYXZlIGEgc2ltcGxlIGxheWVyIG9yIGEgZ3JvdXBlZCBsYXllcgogICAgICAgICAgICBpZiAoaXRlbS4kY2hpbGRyZW4ubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgIC8vIFRoaXMgaXMgYSBncm91cGVkIGxheWVyLCB3ZSBpdGVyYXRlIG92ZXIgdGhlIGxheWVycwogICAgICAgICAgICAgIGl0ZW0uJGNoaWxkcmVuLmZvckVhY2goKHN1Ykl0ZW0pID0+IHsKICAgICAgICAgICAgICAgIC8vIFRPRE86IHByb3BzRGF0YSBkbyBub3QgaGF2ZSBhbGwgdGhlIHBhcmFtZXRlcnMgd2UgbmVlZCAobGlrZSBkYXRlRm9ybWF0RnVuY3Rpb24pCiAgICAgICAgICAgICAgICAvLyBUT0RPIGV4dGVuZCB0aGlzIGdldHRpbmcgdGhlIG1lcmdlZENvbmZpZ3MgaW4gYSBzYW1lIHdheSBhcyB3aGVuIG5vbi1ncm91cGVkCiAgICAgICAgICAgICAgICBzdWJJdGVtLm1hcE9iamVjdC5zZXRQYXJhbXModGhpcy5sYXllck9wdGlvbnMoCiAgICAgICAgICAgICAgICAgIHRpbWUsIHN1Ykl0ZW0uJG9wdGlvbnMucHJvcHNEYXRhLAogICAgICAgICAgICAgICAgKSk7CiAgICAgICAgICAgICAgICAvLyBmb3JjZSByZWRyYXcgb2YgbGF5ZXIKICAgICAgICAgICAgICAgIHN1Ykl0ZW0uJGZvcmNlVXBkYXRlKCk7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgY29uc3Qgb3JpZ2luYWxDb25maWcgPSB0aGlzLm1lcmdlZENvbmZpZ3MoKS5maW5kKChjb25maWcpID0+ICgKICAgICAgICAgICAgICAgIGNvbmZpZy5uYW1lID09PSBpdGVtLm5hbWUKICAgICAgICAgICAgICApKTsKICAgICAgICAgICAgICBpdGVtLm1hcE9iamVjdC5zZXRQYXJhbXModGhpcy5sYXllck9wdGlvbnMoCiAgICAgICAgICAgICAgICB0aW1lLCBvcmlnaW5hbENvbmZpZywKICAgICAgICAgICAgICApKTsKICAgICAgICAgICAgICAvLyBmb3JjZSByZWRyYXcgb2YgbGF5ZXIKICAgICAgICAgICAgICBpdGVtLiRmb3JjZVVwZGF0ZSgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgIH0KICAgIH0sCiAgICByZWZyZXNoTGF5ZXJzKHNpZGUpIHsKICAgICAgLy8gY29tcGFyZShsZWZ0KSBvciBkYXRhKHJpZ2h0KQogICAgICBpZiAoc2lkZSA9PT0gJ2NvbXBhcmUnIHx8IHRoaXMuaW5kaWNhdG9yLmNvbXBhcmVEaXNwbGF5KSB7CiAgICAgICAgdGhpcy5yZWZyZXNoR3JvdXAodGhpcy4kcmVmcy5jb21wYXJlTGF5ZXJBcnJheVdNUywgdGhpcy5jdXJyZW50Q29tcGFyZVRpbWUpOwogICAgICAgIGlmICh0aGlzLiRyZWZzLmNvbXBhcmVMYXllckFycmF5WFlaKSB7CiAgICAgICAgICB0aGlzLiRyZWZzLmNvbXBhcmVMYXllckFycmF5WFlaLmZvckVhY2goKGl0ZW0pID0+IHsKICAgICAgICAgICAgY29uc3Qgb3JpZ2luYWxJbmRleCA9IHBhcnNlSW50KGl0ZW0uJGF0dHJzWydkYXRhLWtleS1vcmlnaW5hbGluZGV4J10sIDEwKTsKICAgICAgICAgICAgdGhpcy5jb21wYXJlTGF5ZXJLZXlYWVpbb3JpZ2luYWxJbmRleF0gPSBNYXRoLnJhbmRvbSgpOwogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIGlmICghdGhpcy5tZXJnZWRDb25maWdzKClbMF0uZmVhdHVyZXNTdGF0aWMKICAgICAgICAgICYmICghdGhpcy5tZXJnZWRDb25maWdzKClbMF0uY3VzdG9tQXJlYUZlYXR1cmVzIHx8IHRoaXMudmFsaWREcmF3bkFyZWEpKSB7CiAgICAgICAgICBpZiAodGhpcy5tZXJnZWRDb25maWdzKClbMF0uZmVhdHVyZXNDbHVzdGVyaW5nKSB7CiAgICAgICAgICAgIHRoaXMuJHJlZnMuZmVhdHVyZXNDb21wYXJlQ2x1c3Rlci5tYXBPYmplY3QuY2xlYXJMYXllcnMoKTsKICAgICAgICAgIH0KICAgICAgICAgIHRoaXMuZmV0Y2hGZWF0dXJlcygnY29tcGFyZScpOwogICAgICAgIH0KICAgICAgfQogICAgICBpZiAoc2lkZSA9PT0gJ2RhdGEnKSB7CiAgICAgICAgdGhpcy5yZWZyZXNoR3JvdXAodGhpcy4kcmVmcy5kYXRhTGF5ZXJBcnJheVdNUywgdGhpcy5jdXJyZW50VGltZSk7CiAgICAgICAgaWYgKHRoaXMuJHJlZnMuZGF0YUxheWVyQXJyYXlYWVopIHsKICAgICAgICAgIHRoaXMuJHJlZnMuZGF0YUxheWVyQXJyYXlYWVouZm9yRWFjaCgoaXRlbSkgPT4gewogICAgICAgICAgICBjb25zdCBvcmlnaW5hbEluZGV4ID0gcGFyc2VJbnQoaXRlbS4kYXR0cnNbJ2RhdGEta2V5LW9yaWdpbmFsaW5kZXgnXSwgMTApOwogICAgICAgICAgICB0aGlzLmRhdGFMYXllcktleVhZWltvcmlnaW5hbEluZGV4XSA9IE1hdGgucmFuZG9tKCk7CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgaWYgKCF0aGlzLm1lcmdlZENvbmZpZ3MoKVswXS5mZWF0dXJlc1N0YXRpYwogICAgICAgICAgJiYgKCF0aGlzLm1lcmdlZENvbmZpZ3MoKVswXS5jdXN0b21BcmVhRmVhdHVyZXMgfHwgdGhpcy52YWxpZERyYXduQXJlYSkpIHsKICAgICAgICAgIGlmICh0aGlzLm1lcmdlZENvbmZpZ3MoKVswXS5mZWF0dXJlc0NsdXN0ZXJpbmcpIHsKICAgICAgICAgICAgdGhpcy4kcmVmcy5mZWF0dXJlc0RhdGFDbHVzdGVyLm1hcE9iamVjdC5jbGVhckxheWVycygpOwogICAgICAgICAgfQogICAgICAgICAgdGhpcy5mZXRjaEZlYXR1cmVzKCdkYXRhJyk7CiAgICAgICAgfQogICAgICB9CiAgICB9LAogICAgZmV0Y2hGZWF0dXJlcyhzaWRlKSB7CiAgICAgIGlmICh0aGlzLm1lcmdlZENvbmZpZ3Moc2lkZSlbMF0uZmVhdHVyZXMpIHsKICAgICAgICBjb25zdCBvcHRpb25zID0gdGhpcy5sYXllck9wdGlvbnMoc2lkZSA9PT0gJ2NvbXBhcmUnID8gdGhpcy5jdXJyZW50Q29tcGFyZVRpbWUgOiB0aGlzLmN1cnJlbnRUaW1lLAogICAgICAgICAgdGhpcy5tZXJnZWRDb25maWdzKHNpZGUpWzBdKTsKICAgICAgICAvLyBhZGQgY3VzdG9tIGFyZWEgaWYgcHJlc2VudAogICAgICAgIGxldCBjdXN0b21BcmVhID0ge307CiAgICAgICAgaWYgKHRoaXMudmFsaWREcmF3bkFyZWEpIHsKICAgICAgICAgIGN1c3RvbUFyZWEgPSB0eXBlb2YgdGhpcy5tZXJnZWRDb25maWdzKClbMF0uZmVhdHVyZXMuYXJlYUZvcm1hdEZ1bmN0aW9uID09PSAnZnVuY3Rpb24nCiAgICAgICAgICAgID8gdGhpcy5tZXJnZWRDb25maWdzKClbMF0uZmVhdHVyZXMuYXJlYUZvcm1hdEZ1bmN0aW9uKHRoaXMuZHJhd25BcmVhKQogICAgICAgICAgICA6IHsgYXJlYTogSlNPTi5zdHJpbmdpZnkodGhpcy5kcmF3bkFyZWEpIH07CiAgICAgICAgfQogICAgICAgIGNvbnN0IHRlbXBsYXRlU3Vic3QgPSB7CiAgICAgICAgICAuLi50aGlzLmluZGljYXRvciwKICAgICAgICAgIC4uLm9wdGlvbnMsCiAgICAgICAgICAuLi5jdXN0b21BcmVhLAogICAgICAgIH07CiAgICAgICAgY29uc3QgdGVtcGxhdGVSZSA9IC9ceyAqKFtcd18gLV0rKSAqXH0vZzsKICAgICAgICBjb25zdCB1cmwgPSB0ZW1wbGF0ZSh0ZW1wbGF0ZVJlLCB0aGlzLm1lcmdlZENvbmZpZ3MoKVswXS5mZWF0dXJlcy51cmwsIHRlbXBsYXRlU3Vic3QpOwogICAgICAgIGxldCByZXF1ZXN0Qm9keSA9IG51bGw7CiAgICAgICAgaWYgKHRoaXMubWVyZ2VkQ29uZmlncygpWzBdLmZlYXR1cmVzLnJlcXVlc3RCb2R5KSB7CiAgICAgICAgICByZXF1ZXN0Qm9keSA9IHsKICAgICAgICAgICAgLi4udGhpcy5tZXJnZWRDb25maWdzKClbMF0uZmVhdHVyZXMucmVxdWVzdEJvZHksCiAgICAgICAgICB9OwogICAgICAgICAgY29uc3QgcGFyYW1zID0gT2JqZWN0LmtleXMocmVxdWVzdEJvZHkpOwogICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBwYXJhbXMubGVuZ3RoOyBpICs9IDEpIHsKICAgICAgICAgICAgLy8gc3Vic3RpdHV0ZSB0ZW1wbGF0ZSBzdHJpbmdzIHdpdGggdmFsdWVzCiAgICAgICAgICAgIHJlcXVlc3RCb2R5W3BhcmFtc1tpXV0gPSB0ZW1wbGF0ZSh0ZW1wbGF0ZVJlLCByZXF1ZXN0Qm9keVtwYXJhbXNbaV1dLCB0ZW1wbGF0ZVN1YnN0KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgY29uc3QgcmVxdWVzdE9wdHMgPSB7CiAgICAgICAgICBjcmVkZW50aWFsczogJ3NhbWUtb3JpZ2luJywKICAgICAgICAgIG1ldGhvZDogdGhpcy5tZXJnZWRDb25maWdzKClbMF0uZmVhdHVyZXMucmVxdWVzdE1ldGhvZCB8fCAnR0VUJywKICAgICAgICAgIGhlYWRlcnM6IHRoaXMubWVyZ2VkQ29uZmlncygpWzBdLmZlYXR1cmVzLnJlcXVlc3RIZWFkZXJzIHx8IHt9LAogICAgICAgIH07CiAgICAgICAgaWYgKHJlcXVlc3RCb2R5KSB7CiAgICAgICAgICByZXF1ZXN0T3B0cy5ib2R5ID0gSlNPTi5zdHJpbmdpZnkocmVxdWVzdEJvZHkpOwogICAgICAgIH0KICAgICAgICB0aGlzLm1hcC5maXJlRXZlbnQoJ2RhdGFsb2FkaW5nJyk7CiAgICAgICAgZmV0Y2godXJsLCByZXF1ZXN0T3B0cykudGhlbigocikgPT4gci5qc29uKCkpCiAgICAgICAgICAudGhlbigocmF3ZGF0YSkgPT4gewogICAgICAgICAgICAvLyBpZiBjdXN0b20gcmVzcG9uc2UgLT4gZmVhdHVyZSBtYXBwaW5nIGZ1bmN0aW9uIGNvbmZpZ3VyZWQsIGFwcGx5IGl0CiAgICAgICAgICAgIGlmICh0eXBlb2YgdGhpcy5tZXJnZWRDb25maWdzKClbMF0uZmVhdHVyZXMuY2FsbGJhY2tGdW5jdGlvbiA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgICAgICAgIHJldHVybiB0aGlzLm1lcmdlZENvbmZpZ3MoKVswXS5mZWF0dXJlcy5jYWxsYmFja0Z1bmN0aW9uKHJhd2RhdGEpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiByYXdkYXRhOwogICAgICAgICAgfSkKICAgICAgICAgIC50aGVuKChkYXRhKSA9PiB7CiAgICAgICAgICAgIHRoaXMubWFwLmZpcmVFdmVudCgnZGF0YWxvYWQnKTsKICAgICAgICAgICAgdGhpcy51cGRhdGVKc29uTGF5ZXJzKGRhdGEsIHNpZGUpOwogICAgICAgICAgfSkKICAgICAgICAgIC5jYXRjaCgoKSA9PiB7CiAgICAgICAgICAgIHRoaXMubWFwLmZpcmVFdmVudCgnZGF0YWxvYWQnKTsKICAgICAgICAgICAgdGhpcy51cGRhdGVKc29uTGF5ZXJzKGVtcHR5Riwgc2lkZSk7CiAgICAgICAgICB9KTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLnVwZGF0ZUpzb25MYXllcnMoZW1wdHlGLCBzaWRlKTsKICAgICAgfQogICAgfSwKICAgIHNlbGVjdEdTQUluZGljYXRvcihmZWF0dXJlKSB7CiAgICAgIHRoaXMuc2VsZWN0ZWRCb3JkZXIgPSBmZWF0dXJlLmJvcmRlcklkOwogICAgICBjb25zdCBkYXRhVXJsID0gYC4vZW9kYXNoLWRhdGEvaW50ZXJuYWwvJHtmZWF0dXJlLmJvcmRlcklkfS5qc29uYDsKICAgICAgdGhpcy5tYXAuZmlyZUV2ZW50KCdkYXRhbG9hZGluZycpOwogICAgICBmZXRjaChkYXRhVXJsKS50aGVuKChyKSA9PiByLmpzb24oKSkKICAgICAgICAudGhlbigoaW5kaWNhdG9yKSA9PiB7CiAgICAgICAgICBjb25zdCByZXR1cm5JbmRpY2F0b3IgPSB7fTsKICAgICAgICAgIHJldHVybkluZGljYXRvci52YWx1ZXMgPSB7IC4uLmluZGljYXRvciB9OwogICAgICAgICAgcmV0dXJuSW5kaWNhdG9yLmluZGljYXRvciA9ICdHU0EnOwogICAgICAgICAgLy8gR2V0IGFsbCB0aW1lcyBvZiBhdmFpbGFibGUgYm9yZGVyIGNyb3NzaW5ncyB0byBhbGxvdyBmaW5kaW5nIG1pbiBtYXgKICAgICAgICAgIHJldHVybkluZGljYXRvci50aW1lID0gW107CiAgICAgICAgICBPYmplY3Qua2V5cyhpbmRpY2F0b3IpLmZvckVhY2goKGtleSkgPT4gewogICAgICAgICAgICBjb25zdCBjdXJyVmFscyA9IGluZGljYXRvcltrZXldLnZhbHVlczsKICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBjdXJyVmFscy5sZW5ndGg7IGkgKz0gMSkgewogICAgICAgICAgICAgIHJldHVybkluZGljYXRvci50aW1lLnB1c2goRGF0ZVRpbWUuZnJvbUlTTyhjdXJyVmFsc1tpXS50aW1lc3RhbXApKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSk7CiAgICAgICAgICByZXR1cm5JbmRpY2F0b3IubWVhc3VyZW1lbnQgPSBbMF07CiAgICAgICAgICByZXR1cm5JbmRpY2F0b3IudGl0bGUgPSBmZWF0dXJlLm5hbWU7CiAgICAgICAgICByZXR1cm5JbmRpY2F0b3IueUF4aXMgPSB0aGlzLmluZGljYXRvci55QXhpczsKICAgICAgICAgIHRoaXMubWFwLmZpcmVFdmVudCgnZGF0YWxvYWQnKTsKICAgICAgICAgIHRoaXMuJHN0b3JlLmNvbW1pdCgKICAgICAgICAgICAgJ2luZGljYXRvcnMvQ1VTVE9NX0FSRUFfSU5ESUNBVE9SX0xPQURfRklOSVNIRUQnLCByZXR1cm5JbmRpY2F0b3IsCiAgICAgICAgICApOwogICAgICAgICAgdGhpcy4kZW1pdCgnZmV0Y2hDdXN0b21BcmVhSW5kaWNhdG9yJyk7CiAgICAgICAgfSkKICAgICAgICAuY2F0Y2goKGVycikgPT4gewogICAgICAgICAgdGhpcy5tYXAuZmlyZUV2ZW50KCdkYXRhbG9hZCcpOwogICAgICAgICAgLy8gSXQgc2VlbXMgZGF0YSBjb3VsZCBub3QgYmUgbG9hZGVkIGxldHMgc2hvdyBhIG5vIGRhdGEgZm91bmQgbWVzc2FnZQogICAgICAgICAgdGhpcy4kc3RvcmUuY29tbWl0KAogICAgICAgICAgICAnaW5kaWNhdG9ycy9DVVNUT01fQVJFQV9JTkRJQ0FUT1JfTE9BRF9GSU5JU0hFRCcsIHsgaXNFbXB0eTogdHJ1ZSB9LAogICAgICAgICAgKTsKICAgICAgICAgIGNvbnNvbGUubG9nKGVycik7CiAgICAgICAgfSk7CiAgICB9LAogICAgZmV0Y2hNb2JpbGl0eURhdGEoY291bnRyeUNvZGUsIGFvaUlEKSB7CiAgICAgIGNvbnN0IGRhdGFVcmwgPSBgLi9lb2Rhc2gtZGF0YS9pbnRlcm5hbC8ke2NvdW50cnlDb2RlfS0ke2FvaUlEfS5qc29uYDsKICAgICAgdGhpcy5tYXAuZmlyZUV2ZW50KCdkYXRhbG9hZGluZycpOwogICAgICBmZXRjaChkYXRhVXJsKS50aGVuKChyKSA9PiByLmpzb24oKSkKICAgICAgICAudGhlbigoaW5kaWNhdG9yKSA9PiB7CiAgICAgICAgICBpbmRpY2F0b3IuaW5kaWNhdG9yID0gYW9pSUQ7IC8vIGVzbGludC1kaXNhYmxlLWxpbmUKICAgICAgICAgIGluZGljYXRvci50aW1lID0gaW5kaWNhdG9yLlZhbHVlcy5tYXAoKHJvdykgPT4gRGF0ZVRpbWUuZnJvbUlTTyhyb3cuZGF0ZSkpOyAvLyBlc2xpbnQtZGlzYWJsZS1saW5lCiAgICAgICAgICBpbmRpY2F0b3IubWVhc3VyZW1lbnQgPSBbMF07IC8vIGVzbGludC1kaXNhYmxlLWxpbmUKICAgICAgICAgIGluZGljYXRvci5jb3VudHJ5ID0gaW5kaWNhdG9yLkNvdW50cnlDb2RlOyAvLyBlc2xpbnQtZGlzYWJsZS1saW5lCiAgICAgICAgICBpbmRpY2F0b3IudGl0bGUgPSBpbmRpY2F0b3IuQ291bnRyeU5hbWU7IC8vIGVzbGludC1kaXNhYmxlLWxpbmUKICAgICAgICAgIGluZGljYXRvci55QXhpcyA9IHRoaXMuaW5kaWNhdG9yLnlBeGlzOyAvLyBlc2xpbnQtZGlzYWJsZS1saW5lCiAgICAgICAgICB0aGlzLm1hcC5maXJlRXZlbnQoJ2RhdGFsb2FkJyk7CiAgICAgICAgICB0aGlzLiRzdG9yZS5jb21taXQoCiAgICAgICAgICAgICdpbmRpY2F0b3JzL0NVU1RPTV9BUkVBX0lORElDQVRPUl9MT0FEX0ZJTklTSEVEJywgaW5kaWNhdG9yLAogICAgICAgICAgKTsKICAgICAgICAgIHRoaXMuJGVtaXQoJ2ZldGNoQ3VzdG9tQXJlYUluZGljYXRvcicpOwogICAgICAgIH0pCiAgICAgICAgLmNhdGNoKChlcnIpID0+IHsKICAgICAgICAgIHRoaXMubWFwLmZpcmVFdmVudCgnZGF0YWxvYWQnKTsKICAgICAgICAgIC8vIEl0IHNlZW1zIGRhdGEgY291bGQgbm90IGJlIGxvYWRlZCBsZXRzIHNob3cgYSBubyBkYXRhIGZvdW5kIG1lc3NhZ2UKICAgICAgICAgIHRoaXMuJHN0b3JlLmNvbW1pdCgKICAgICAgICAgICAgJ2luZGljYXRvcnMvQ1VTVE9NX0FSRUFfSU5ESUNBVE9SX0xPQURfRklOSVNIRUQnLCB7IGlzRW1wdHk6IHRydWUgfSwKICAgICAgICAgICk7CiAgICAgICAgICBjb25zb2xlLmxvZyhlcnIpOwogICAgICAgIH0pOwogICAgfSwKICAgIGZldGNoQ3VzdG9tQXJlYUluZGljYXRvcigpIHsKICAgICAgY29uc3Qgb3B0aW9ucyA9IHRoaXMubGF5ZXJPcHRpb25zKHRoaXMuY3VycmVudFRpbWUsIHRoaXMubWVyZ2VkQ29uZmlncygpWzBdKTsKICAgICAgLy8gYWRkIGN1c3RvbSBhcmVhIGlmIHByZXNlbnQKICAgICAgbGV0IGN1c3RvbUFyZWEgPSB7fTsKICAgICAgaWYgKHRoaXMudmFsaWREcmF3bkFyZWEpIHsKICAgICAgICBjdXN0b21BcmVhID0gdHlwZW9mIHRoaXMubWVyZ2VkQ29uZmlncygpWzBdLmFyZWFJbmRpY2F0b3IuYXJlYUZvcm1hdEZ1bmN0aW9uID09PSAnZnVuY3Rpb24nCiAgICAgICAgICA/IHRoaXMubWVyZ2VkQ29uZmlncygpWzBdLmFyZWFJbmRpY2F0b3IuYXJlYUZvcm1hdEZ1bmN0aW9uKHRoaXMuZHJhd25BcmVhKQogICAgICAgICAgOiB7IGFyZWE6IEpTT04uc3RyaW5naWZ5KHRoaXMuZHJhd25BcmVhKSB9OwogICAgICB9CiAgICAgIHRoaXMuaW5kaWNhdG9yLnRpdGxlID0gJ1VzZXIgZGVmaW5lZCBhcmVhIG9mIGludGVyZXN0JzsKICAgICAgY29uc3QgdGVtcGxhdGVTdWJzdCA9IHsKICAgICAgICAuLi50aGlzLmluZGljYXRvciwKICAgICAgICAuLi5vcHRpb25zLAogICAgICAgIC4uLmN1c3RvbUFyZWEsCiAgICAgIH07CiAgICAgIGNvbnN0IHRlbXBsYXRlUmUgPSAvXHsgKihbXHdfIC1dKykgKlx9L2c7CiAgICAgIGNvbnN0IHVybCA9IHRlbXBsYXRlKHRlbXBsYXRlUmUsIHRoaXMubWVyZ2VkQ29uZmlncygpWzBdLmFyZWFJbmRpY2F0b3IudXJsLCB0ZW1wbGF0ZVN1YnN0KTsKICAgICAgbGV0IHJlcXVlc3RCb2R5ID0gbnVsbDsKICAgICAgaWYgKHRoaXMubWVyZ2VkQ29uZmlncygpWzBdLmFyZWFJbmRpY2F0b3IucmVxdWVzdEJvZHkpIHsKICAgICAgICByZXF1ZXN0Qm9keSA9IHsKICAgICAgICAgIC4uLnRoaXMubWVyZ2VkQ29uZmlncygpWzBdLmFyZWFJbmRpY2F0b3IucmVxdWVzdEJvZHksCiAgICAgICAgfTsKICAgICAgICBjb25zdCBwYXJhbXMgPSBPYmplY3Qua2V5cyhyZXF1ZXN0Qm9keSk7CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBwYXJhbXMubGVuZ3RoOyBpICs9IDEpIHsKICAgICAgICAgIC8vIHN1YnN0aXR1dGUgdGVtcGxhdGUgc3RyaW5ncyB3aXRoIHZhbHVlcwogICAgICAgICAgaWYgKHR5cGVvZiByZXF1ZXN0Qm9keVtwYXJhbXNbaV1dID09PSAnc3RyaW5nJykgewogICAgICAgICAgICByZXF1ZXN0Qm9keVtwYXJhbXNbaV1dID0gdGVtcGxhdGUodGVtcGxhdGVSZSwgcmVxdWVzdEJvZHlbcGFyYW1zW2ldXSwgdGVtcGxhdGVTdWJzdCk7CiAgICAgICAgICB9CiAgICAgICAgICAvLyBDb252ZXJ0IGdlb2pzb25zIGJhY2sgdG8gYW4gb2JqZWN0CiAgICAgICAgICBpZiAocGFyYW1zW2ldID09PSAnZ2VvanNvbicpIHsKICAgICAgICAgICAgcmVxdWVzdEJvZHlbcGFyYW1zW2ldXSA9IEpTT04ucGFyc2UocmVxdWVzdEJvZHlbcGFyYW1zW2ldXSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICAgIGNvbnN0IHJlcXVlc3RPcHRzID0gewogICAgICAgIGNyZWRlbnRpYWxzOiAnc2FtZS1vcmlnaW4nLAogICAgICAgIG1ldGhvZDogdGhpcy5tZXJnZWRDb25maWdzKClbMF0uYXJlYUluZGljYXRvci5yZXF1ZXN0TWV0aG9kIHx8ICdHRVQnLAogICAgICAgIGhlYWRlcnM6IHRoaXMubWVyZ2VkQ29uZmlncygpWzBdLmFyZWFJbmRpY2F0b3IucmVxdWVzdEhlYWRlcnMgfHwge30sCiAgICAgIH07CiAgICAgIGlmIChyZXF1ZXN0Qm9keSkgewogICAgICAgIHJlcXVlc3RPcHRzLmJvZHkgPSBKU09OLnN0cmluZ2lmeShyZXF1ZXN0Qm9keSk7CiAgICAgIH0KICAgICAgdGhpcy5tYXAuZmlyZUV2ZW50KCdkYXRhbG9hZGluZycpOwogICAgICBmZXRjaCh1cmwsIHJlcXVlc3RPcHRzKS50aGVuKChyKSA9PiByLmpzb24oKSkKICAgICAgICAudGhlbigocmF3ZGF0YSkgPT4gewogICAgICAgICAgaWYgKHR5cGVvZiB0aGlzLm1lcmdlZENvbmZpZ3MoKVswXS5hcmVhSW5kaWNhdG9yLmNhbGxiYWNrRnVuY3Rpb24gPT09ICdmdW5jdGlvbicpIHsKICAgICAgICAgICAgLy8gbWVyZ2UgZGF0YSBmcm9tIGN1cnJlbnQgaW5kaWNhdG9yIGRhdGEgYW5kIG5ldyBkYXRhIGZyb20gYXBpCiAgICAgICAgICAgIC8vIHJldHVybnMgbmV3IGluZGljYXRvciBvYmplY3QgdG8gc2V0IGFzIGN1c3RvbSBhcmVhIGluZGljYXRvcgogICAgICAgICAgICByZXR1cm4gdGhpcy5tZXJnZWRDb25maWdzKClbMF0uYXJlYUluZGljYXRvci5jYWxsYmFja0Z1bmN0aW9uKHJhd2RhdGEsIHRoaXMuaW5kaWNhdG9yKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiByYXdkYXRhOwogICAgICAgIH0pCiAgICAgICAgLnRoZW4oKGluZGljYXRvcikgPT4gewogICAgICAgICAgdGhpcy5tYXAuZmlyZUV2ZW50KCdkYXRhbG9hZCcpOwogICAgICAgICAgdGhpcy4kc3RvcmUuY29tbWl0KAogICAgICAgICAgICAnaW5kaWNhdG9ycy9DVVNUT01fQVJFQV9JTkRJQ0FUT1JfTE9BRF9GSU5JU0hFRCcsIGluZGljYXRvciwKICAgICAgICAgICk7CiAgICAgICAgICB0aGlzLiRlbWl0KCdmZXRjaEN1c3RvbUFyZWFJbmRpY2F0b3InKTsKICAgICAgICB9KQogICAgICAgIC5jYXRjaCgoZXJyKSA9PiB7CiAgICAgICAgICB0aGlzLm1hcC5maXJlRXZlbnQoJ2RhdGFsb2FkJyk7CiAgICAgICAgICB0aGlzLiRzdG9yZS5jb21taXQoCiAgICAgICAgICAgICdpbmRpY2F0b3JzL0NVU1RPTV9BUkVBX0lORElDQVRPUl9MT0FEX0ZJTklTSEVEJywgbnVsbCwKICAgICAgICAgICk7CiAgICAgICAgICBjb25zb2xlLmxvZyhlcnIpOwogICAgICAgIH0pOwogICAgfSwKICAgIGNsZWFyQ3VzdG9tQXJlYUZpbHRlcigpIHsKICAgICAgdGhpcy4kc3RvcmUuY29tbWl0KCdmZWF0dXJlcy9TRVRfU0VMRUNURURfQVJFQScsIG51bGwpOwogICAgfSwKICAgIGdldERhdGFGKCkgewogICAgICByZXR1cm4gZGF0YUY7CiAgICB9LAogICAgZ2V0Q29tcGFyZUYoKSB7CiAgICAgIHJldHVybiBjb21wYXJlRjsKICAgIH0sCiAgICB1cGRhdGVKc29uTGF5ZXJzKGZ0cnMsIHNpZGUpIHsKICAgICAgaWYgKHRoaXMubWVyZ2VkQ29uZmlncygpWzBdLmZlYXR1cmVzQ2x1c3RlcmluZykgewogICAgICAgIC8vIG1hcmtlcmNsdXN0ZXIgbmVlZHMgbWFudWFsIGFkZGluZyBvZiBhbGwgZ2VvanNvbnMgaXQgd2lsbCBzaG93CiAgICAgICAgLy8gYW5kIGNsZWFudXAgb2YgcHJldmlvdXMgY29udGVudAogICAgICAgIGNvbnN0IGdlb2pzb25Gcm9tRGF0YSA9IGdlb0pzb24oZnRycywgewogICAgICAgICAgLi4udGhpcy5mZWF0dXJlT3B0aW9ucyhzaWRlKSwKICAgICAgICAgIHBhbmU6IHNpZGUgPT09ICdkYXRhJyA/IHRoaXMudG9vbHRpcFBhbmUgOiB0aGlzLnNoYWRvd1BhbmUsCiAgICAgICAgfSk7CiAgICAgICAgaWYgKHRoaXMuJHJlZnMuZmVhdHVyZXNEYXRhQ2x1c3RlcikgewogICAgICAgICAgaWYgKHNpZGUgPT09ICdkYXRhJykgewogICAgICAgICAgICB0aGlzLiRyZWZzLmZlYXR1cmVzRGF0YUNsdXN0ZXIubWFwT2JqZWN0LmNsZWFyTGF5ZXJzKCk7CiAgICAgICAgICAgIHRoaXMuJHJlZnMuZmVhdHVyZXNEYXRhQ2x1c3Rlci5tYXBPYmplY3QuYWRkTGF5ZXJzKFtnZW9qc29uRnJvbURhdGFdKTsKICAgICAgICAgICAgdGhpcy5kYXRhRmVhdHVyZXNDb3VudCA9IGZ0cnMuZmVhdHVyZXMubGVuZ3RoOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhpcy4kcmVmcy5mZWF0dXJlc0NvbXBhcmVDbHVzdGVyLm1hcE9iamVjdC5jbGVhckxheWVycygpOwogICAgICAgICAgICB0aGlzLiRyZWZzLmZlYXR1cmVzQ29tcGFyZUNsdXN0ZXIubWFwT2JqZWN0LmFkZExheWVycyhbZ2VvanNvbkZyb21EYXRhXSk7CiAgICAgICAgICAgIHRoaXMuY29tcGFyZUZlYXR1cmVzQ291bnQgPSBmdHJzLmZlYXR1cmVzLmxlbmd0aDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0gZWxzZSBpZiAoc2lkZSA9PT0gJ2RhdGEnKSB7CiAgICAgICAgLy8gbm9ybWFsIGdlb2pzb24gbGF5ZXIganVzdCBuZWVkcyBtYW51YWwgcmVmcmVzaAogICAgICAgIHRoaXMuZGF0YUpzb25Db21wdXRlZCA9IGZ0cnM7CiAgICAgICAgdGhpcy5kYXRhSnNvbktleSA9IE1hdGgucmFuZG9tKCk7CiAgICAgICAgdGhpcy5kYXRhRmVhdHVyZXNDb3VudCA9IGZ0cnMuZmVhdHVyZXMubGVuZ3RoOwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMuY29tcGFyZUpzb25Db21wdXRlZCA9IGZ0cnM7CiAgICAgICAgdGhpcy5jb21wYXJlSnNvbktleSA9IE1hdGgucmFuZG9tKCk7CiAgICAgICAgdGhpcy5jb21wYXJlRmVhdHVyZXNDb3VudCA9IGZ0cnMuZmVhdHVyZXMubGVuZ3RoOwogICAgICB9CiAgICB9LAogIH0sCiAgd2F0Y2g6IHsKICAgIGVuYWJsZUNvbXBhcmUob24pIHsKICAgICAgaWYgKCFvbikgewogICAgICAgIGlmICh0aGlzLnNsaWRlciAhPT0gbnVsbCkgewogICAgICAgICAgdGhpcy5tYXAucmVtb3ZlQ29udHJvbCh0aGlzLnNsaWRlcik7CiAgICAgICAgICB0aGlzLm1hcC5yZW1vdmVMYXllcih0aGlzLiRyZWZzLmNvbXBhcmVMYXllcnMubWFwT2JqZWN0KTsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5tYXAuYWRkTGF5ZXIodGhpcy4kcmVmcy5jb21wYXJlTGF5ZXJzLm1hcE9iamVjdCk7CiAgICAgICAgaWYgKCF0aGlzLm1lcmdlZENvbmZpZ3MoKVswXS5jdXN0b21BcmVhRmVhdHVyZXMgfHwgdGhpcy52YWxpZERyYXduQXJlYSkgewogICAgICAgICAgdGhpcy5mZXRjaEZlYXR1cmVzKCdjb21wYXJlJyk7CiAgICAgICAgfQogICAgICAgIHRoaXMuJG5leHRUaWNrKCgpID0+IHsKICAgICAgICAgIHRoaXMuc2xpZGVyLnNldExlZnRMYXllcnMoCiAgICAgICAgICAgIHRoaXMuZXh0cmFjdEFjdHVhbExheWVycyh0aGlzLiRyZWZzLmNvbXBhcmVMYXllcnMpLAogICAgICAgICAgKTsKICAgICAgICAgIHRoaXMuc2xpZGVyLnNldFJpZ2h0TGF5ZXJzKAogICAgICAgICAgICB0aGlzLmV4dHJhY3RBY3R1YWxMYXllcnModGhpcy4kcmVmcy5kYXRhTGF5ZXJzKSwKICAgICAgICAgICk7CiAgICAgICAgICB0aGlzLnNsaWRlci5hZGRUbyh0aGlzLm1hcCk7CiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0sCiAgICBkcmF3bkFyZWEoKSB7CiAgICAgIC8vIHdhdGNoIG9uIGRyYXduIGFyZWEgcHJvcCBjaGFuZ2UgdHJpZ2dlcmluZyB1cGRhdGUgb2YgZHJhdyBsYXllciwgZmV0Y2hpbmcgY3VzdG9tIGZlYXR1cmVzCiAgICAgIHRoaXMudXBkYXRlU2VsZWN0ZWRBcmVhRmVhdHVyZSgpOwogICAgfSwKICB9LAp9Owo="},null]}